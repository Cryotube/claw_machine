# Godot Story: Claw Rig Control & Physics Integration

**Epic:** Epic 1 – Core Order Fulfillment Loop  
**Story ID:** 1.3  
**Priority:** High  
**Points:** 8  
**Status:** Ready for Review  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Implement the interactive claw rig by wiring the on-screen virtual controls (thumbstick + action buttons) to the articulated solver so players can maneuver, grab, and lift seafood inside the freezer. The system must respect physics budgets, swap to pooled seafood bodies, and emit deterministic solver events for downstream scoring. [Source: game-prd/requirements.md#functional][Source: architecture/gameplay-systems-architecture.md#gameplay-components][Source: architecture/game-systems-components.md#core-systems]

**Godot Implementation:** Build typed GDScript controllers for `ClawInputController` and `ClawRigSolver`, instanced under `ClawCabinet` with exported references to pooled seafood nodes, autoload services, and the Session HUD’s virtual joystick/action buttons, following the scene composition patterns. [Source: architecture/high-level-architecture.md#high-level-overview][Source: architecture/node-architecture-details.md#node-patterns][Source: architecture/godot-development-conventions.md#best-practices]

**Performance Impact:** Maintain sub-16.67 ms frame time by running the solver within the 60 Hz physics budget, pooling seafood bodies, and avoiding allocations in per-frame loops. [Source: architecture/performance-and-security-considerations.md#performance-budgets][Source: architecture/physics-configuration.md#physics-settings][Source: architecture/node-architecture-details.md#resource-architecture]

## Acceptance Criteria
### Functional Requirements
- `ClawInputController` maps the virtual joystick vector plus on-screen buttons (`claw_extend_close`, `claw_retract`) into solver intents with <50 ms latency across touch and gamepad; hold-to-extend and release-to-clamp behaviour mirrors UX spec. [Source: architecture/input-system-architecture.md#input-actions-configuration][Source: architecture/input-system-architecture.md#input-handling-patterns][Source: game-prd/requirements.md#non-functional]
- `ClawRigSolver` drives the articulated state machine (`Idle → Aiming → Descending → Gripping → Carrying → Dropping`) and emits typed success/failure signals via `SignalHub`. [Source: architecture/state-machine-architecture.md#entity-state-machines][Source: architecture/game-systems-components.md#core-systems]
- Successful grabs attach pooled seafood soft bodies using pinned vertices and gravity modifiers defined for the freezer interior. [Source: architecture/physics-configuration.md#rigidbody--soft-body-patterns][Source: architecture/node-architecture-details.md#node-patterns]
- Release events dispatch `CabinetItemDescriptor` data back to `OrderService` for scoring and clear solver state without leaving active constraints. [Source: architecture/game-systems-components.md#system-interaction-session-core][Source: architecture/game-data-models.md#game-data-models]

### Technical Requirements
- Code follows typed GDScript best practices with cached references (no runtime `get_node()` in `_physics_process`). [Source: architecture/godot-development-conventions.md#best-practices]
- Maintains 60+ FPS on all target devices (frame time <16.67 ms). [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Object pooling implemented for seafood items and claw debris. [Source: architecture/node-architecture-details.md#node-patterns]
- Signals properly connected and cleaned up on state transitions. [Source: architecture/game-systems-components.md#core-systems]
- GUT coverage ≥ 80%. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- Solver loop allocates zero new objects after warmup. [Source: architecture/performance-and-security-considerations.md#performance-budgets]

### Game Design Requirements
- Claw responsiveness mirrors UX expectations, supporting smooth aim assist and thumbstick damping with forgiving button timing. [Source: front-end-spec.md#fulfill-customer-order-during-score-run][Source: architecture/input-system-architecture.md#input-handling-patterns]
- Grab and release events trigger the appropriate audio/haptic cues for player feedback. [Source: architecture/audio-architecture.md#system-design][Source: front-end-spec.md#fulfill-customer-order-during-score-run]
- Soft-body deformation appears believable yet cozy, matching art direction and avoiding jitter. [Source: architecture/physics-configuration.md#rigidbody--soft-body-patterns][Source: architecture/rendering-pipeline-configuration.md#render-pipeline-setup]

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**
- `res://scenes/session/ClawRig.tscn` – Rig hierarchy including arm bones, grabber, cable joints, and physics colliders instanced under `ClawCabinet`. [Source: architecture/high-level-architecture.md#high-level-overview][Source: architecture/gameplay-systems-architecture.md#gameplay-components]
- `res://scenes/session/CabinetItemPool.tscn` – Pooled seafood container with rigid/soft-body variants and spawn markers. [Source: architecture/node-architecture-details.md#node-patterns][Source: architecture/physics-configuration.md#rigidbody--soft-body-patterns]

**New Scripts:**
- `res://scripts/gameplay/claw_input_controller.gd` – Handles virtual joystick sampling, input dead zones, and action button states before forwarding intents. [Source: architecture/input-system-architecture.md#input-handling-patterns][Source: architecture/godot-development-conventions.md#best-practices]
- `res://scripts/gameplay/claw_rig_solver.gd` – Physics solver managing joint targets, grip strength, and state transitions. [Source: architecture/game-systems-components.md#core-systems][Source: architecture/physics-configuration.md#physics-settings]

**Modified Files:**
- `res://autoload/SignalHub.gd` – Register claw events (`claw_grab_started`, `claw_grab_failed`, `claw_item_captured`, `claw_item_released`). [Source: architecture/game-systems-components.md#core-systems]
- `res://autoload/OrderService.gd` – Accept solver callbacks delivering descriptor data for scoring pipeline. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- `res://scenes/session/SessionRoot.tscn` – Wire claw nodes, item pool, and input controller references. [Source: architecture/high-level-architecture.md#high-level-overview]
- `res://scripts/gameplay/cabinet_item_pool.gd` – Implement pooling API for soft-body seafood and rigid fallback. [Source: architecture/node-architecture-details.md#node-patterns]
- `res://scripts/services/game_state.gd` – Pause/resume solver when game state changes. [Source: architecture/game-systems-components.md#core-systems]
- `res://ui/screens/SessionHUD.tscn` – Surface virtual joystick and action buttons, routing signals into `ClawInputController`. [Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-component-system.md#component-library]
- `project.godot` – Register `claw_extend_close` and `claw_retract` InputMap actions used by the virtual controls. [Source: architecture/input-system-architecture.md#input-actions-configuration]

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# claw_input_controller.gd
class_name ClawInputController
extends Node

@export var solver: ClawRigSolver
@export var joystick: VirtualJoystick
@export var extend_button: Button
@export var retract_button: Button
@export var smoothing: float = 0.15

func _ready() -> void:
    joystick.vector_changed.connect(_on_vector_changed)
    extend_button.pressed.connect(_on_extend_pressed)
    extend_button.released.connect(_on_extend_released)
    retract_button.pressed.connect(_on_retract_pressed)

func _on_vector_changed(vector: Vector2) -> void:
    solver.set_move_vector(_apply_smoothing(vector))

func _on_extend_pressed() -> void:
    solver.begin_lower()

func _on_extend_released() -> void:
    solver.execute_grip()

func _on_retract_pressed() -> void:
    solver.retract_to_idle()
```
The controller caches references, normalizes input, and forwards typed calls to the solver without per-frame allocations. [Source: architecture/input-system-architecture.md#input-handling-patterns][Source: architecture/godot-development-conventions.md#best-practices]

**Physics Solver Hooks:** `ClawRigSolver` updates joint targets inside `_physics_process`, fetches pooled seafood bodies, and emits typed signals through `SignalHub` to keep downstream systems decoupled. [Source: architecture/physics-configuration.md#physics-settings][Source: architecture/game-systems-components.md#core-systems]

### Implementation Strategy
Build the solver using explicit state enums to ensure deterministic transitions and easy testing, mirroring the architecture’s entity state machine guidance. [Source: architecture/state-machine-architecture.md#entity-state-machines]  
Reserve item bodies at load via `CabinetItemPool` so grabs simply attach existing nodes, avoiding runtime instantiation. [Source: architecture/node-architecture-details.md#node-patterns][Source: architecture/physics-configuration.md#rigidbody--soft-body-patterns]  
Iterate via TDD: author solver unit tests first, then integrate with scene nodes, and profile using headless runs to confirm the physics budget. [Source: architecture/test-strategy-and-standards.md#testing-philosophy][Source: architecture/performance-and-security-considerations.md#performance-budgets]

### Tasks / Subtasks
- [x] **Prototype Input Controller (AC: 1)** – Wire the virtual joystick vector, extend/close button hold+release flow, and retract button events into solver intents with latency tests. [Source: architecture/input-system-architecture.md#input-handling-patterns]
- [x] **Author Solver State Machine (AC: 2)** – Build enum-driven solver with typed signals, update clamps, and integrate with `SignalHub`. [Source: architecture/state-machine-architecture.md#entity-state-machines][Source: architecture/game-systems-components.md#core-systems]
- [x] **Integrate Seafood Pooling (AC: 3, 4)** – Connect solver to `CabinetItemPool`, attach soft bodies, and define rigid fallback path. [Source: architecture/node-architecture-details.md#node-patterns][Source: architecture/physics-configuration.md#rigidbody--soft-body-patterns]
- [x] **TDD & Profiling (AC: 1–4)** – Write GUT tests for solver transitions, pooling reuse, and failure paths; capture profiler snapshots to confirm <16.67 ms frames during claw stress scenarios. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization][Source: architecture/performance-and-security-considerations.md#performance-budgets]
- [x] **Documentation & Signals (AC: 2, 4)** – Update story Dev Agent record, document solver APIs, and confirm downstream services consume new events. [Source: architecture/core-game-workflows.md#core-game-workflows]

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**
- `res://tests/gut/unit/test_claw_input_controller.gd`
- `res://tests/gut/unit/test_claw_rig_solver.gd`
- Coverage Target: 80% minimum. Tests validate state transitions, pooling reuse, and latency budgets. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]

**Test Scenarios (Write First - Red Phase):**
- Virtual joystick vectors translate to solver move commands respecting dead zones. [Source: architecture/input-system-architecture.md#input-handling-patterns]
- Extend/close button hold triggers lowering while release issues the clamp command; retract button returns the claw to idle. [Source: architecture/input-system-architecture.md#input-handling-patterns]
- Solver emits `claw_item_captured` only after grip threshold satisfied. [Source: architecture/game-systems-components.md#core-systems]
- Pool reuse returns seafood bodies without exceeding target allocations. [Source: architecture/node-architecture-details.md#node-patterns]

### Game Testing
1. Play session in editor with touch emulation: use the virtual joystick plus extend/close and retract buttons to aim, capture, and deliver three orders.  
   - Expected: Claw responds smoothly; solver states visible in debug overlay; audio/haptic cues fire on grab. [Source: front-end-spec.md#fulfill-customer-order-during-score-run][Source: architecture/audio-architecture.md#system-design]  
   - Performance: Maintain ≥60 FPS, no spikes above 16.67 ms. [Source: architecture/performance-and-security-considerations.md#performance-budgets]  
   - Physics: No jitter or slipping when carrying seafood. [Source: architecture/physics-configuration.md#physics-settings]
2. Force failure by grabbing wrong item and dropping.  
   - Expected: `claw_grab_failed` emitted, solver resets to `Idle`, OrderService receives descriptor for penalty. [Source: architecture/game-systems-components.md#system-interaction-session-core]  
   - Memory: Pool size constant in profiler snapshot. [Source: architecture/node-architecture-details.md#node-patterns]  
   - Signals: No duplicate connections detected when pausing/resuming. [Source: architecture/godot-development-conventions.md#workflow-conventions]

### Performance Tests
**Godot Profiler Metrics (Mandatory):**
- Frame rate: 60+ FPS under three simultaneous grab attempts. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Frame time: <16.67 ms average. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Physics frame: <4 ms. [Source: architecture/physics-configuration.md#physics-settings]
- Memory usage: <1400 MB iOS / 1600 MB Android during stress test. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Draw calls: <750 with cabinet interior active. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]
- Object pools: No new seafood instances created after warmup. [Source: architecture/node-architecture-details.md#node-patterns]
- GDScript static typing: Verified by test run and lint. [Source: architecture/godot-development-conventions.md#best-practices]
- Solver allocations per frame: zero (monitored with `Engine.get_frames_per_second()` instrumentation). [Source: architecture/performance-and-security-considerations.md#performance-budgets]

## Dependencies
**Story Dependencies:**
- 1.1 – Customer Queue & Order Announcements: provides order lifecycle context for solver callbacks. [Source: docs/stories/epic-1-core-order-fulfillment-loop/1.1-customer-queue-and-order-announcements.md]
- 1.2 – Order Visualization & Cabinet Highlighting: supplies cabinet highlight hooks to reflect solver state. [Source: docs/stories/epic-1-core-order-fulfillment-loop/1.2-order-visualization-and-cabinet-highlighting.md]

**Godot System Dependencies:**
- Node: `SessionRoot` instantiates `ClawCabinet`, `SignalHub`, `OrderService`, and `CabinetItemPool`. [Source: architecture/high-level-architecture.md#high-level-overview]
- Autoload: `SignalHub`, `OrderService`, `Settings`, `GameState`. [Source: architecture/game-systems-components.md#core-systems]
- Language: Typed GDScript enforcement enabled. [Source: architecture/godot-development-conventions.md#workflow-conventions]

**Resource Dependencies:**
- Resource Type: `.tres`
- Asset: `cabinet_item_descriptors.tres`, `claw_joint_profiles.tres`, `input_curve_profiles.tres`  
- Location: `res://resources/data/` and `res://resources/curves/`  
- Import Settings: Preserve curve precision and soft-body mesh compression settings per pipeline. [Source: architecture/node-architecture-details.md#resource-architecture]
- UI Assets: `res://ui/components/VirtualJoystick.tscn`, extend/retract action buttons defined in Session HUD. [Source: front-end-spec.md#virtualjoystick][Source: architecture/ui-component-system.md#component-library]

## Definition of Done
- All acceptance criteria met. [Source: game-prd/epics/epic-1-core-order-loop.md#stories]
- TDD followed (tests written first, then implementation). [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GUT tests passing (GDScript) with 80%+ coverage. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GoDotTest passing (C#) with 80%+ coverage (N/A if unused). [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]
- Performance: 60+ FPS maintained on all platforms. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Static typing used in all GDScript. [Source: architecture/godot-development-conventions.md#best-practices]
- Object pooling active for seafood bodies. [Source: architecture/node-architecture-details.md#node-patterns]
- Signals properly connected and cleaned up. [Source: architecture/game-systems-components.md#core-systems]
- No GDScript warnings. [Source: architecture/godot-development-conventions.md#workflow-conventions]
- Node hierarchy follows architecture diagram. [Source: architecture/high-level-architecture.md#high-level-overview]
- Resources configured with validated import presets. [Source: architecture/node-architecture-details.md#resource-architecture]
- Export templates tested. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Documentation updated. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Solver profiler snapshot attached showing zero allocations per frame. [Source: architecture/performance-and-security-considerations.md#performance-budgets]

## Notes
**Godot Implementation Notes:**
- Language Choice: GDScript ensures solver integrates tightly with existing services while benefiting from static typing. [Source: architecture/godot-development-conventions.md#best-practices]
- Node Architecture: Claw rig and item pool live under `ClawCabinet` for modular testing. [Source: architecture/high-level-architecture.md#high-level-overview]
- Signal Pattern: All solver events run through `SignalHub` for decoupled scoring/UX handling. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- Joint limits and easing values stored in resources for designer iteration. [Source: architecture/node-architecture-details.md#resource-architecture]

**Performance Decisions:**
- Static Typing: Mandatory across solver and controller for 10–20 % gain. [Source: architecture/godot-development-conventions.md#best-practices]
- C# Usage: Not required; architecture keeps claw solver in GDScript. [Source: architecture/game-systems-components.md#core-systems]
- Object Pooling: Preinstantiate seafood bodies and collisions to prevent runtime spikes. [Source: architecture/node-architecture-details.md#node-patterns]
- Physics tuning: Respect 60 Hz tick with solver iteration counts defined in configuration. [Source: architecture/physics-configuration.md#physics-settings]

**Future Optimizations:**
- Investigate GPU skinning for claw arm if draw calls inflate under heavy effects. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]
- Add deterministic solver replay fixtures for regression testing. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- Explore adaptive grip assist for accessibility without breaking physics budgets. [Source: architecture/input-system-architecture.md#input-handling-patterns]

## Dev Agent Record
### Agent Model Used
- Carmack (Game Developer)

### Debug Log
- Authored new GUT specifications (`test_claw_input_controller.gd`, `test_claw_rig_solver.gd`) before implementation and integrated them into the shared `test_runner` manifest.
- Implemented `ClawInputController`, `ClawRigSolver`, and `CabinetItemPool` with typed GDScript, wiring solver state transitions, pooling reuse, and SignalHub broadcasts.
- Added virtual joystick and action buttons to `SessionRoot` HUD, binding them through the input controller to the solver.
- Extended `SignalHub` and `OrderService` to support claw grab/capture/release events and order delivery validation.
- Seeded placeholder tuning resources (`claw_joint_profiles.tres`, `input_curve_profiles.tres`) and registered new InputMap actions for claw controls.
- Updated `scripts/godot-cli.sh` to auto-detect `artifacts/godot/Godot.app`, set a project-local Godot home, and unblock headless runs in the Codex sandbox.
- Verified the new flow with `./scripts/godot-cli.sh --headless --run res://tests/gut/test_runner.tscn` (passes 17 tests) and documented the expectation in `docs/architecture/tech-stack.md` for future agents.

### Completion Notes
- Virtual joystick plus extend/retract buttons now drive the claw rig through the new input controller.
- Solver state machine captures seafood from the pooled inventory, emits SignalHub events, and hands deliveries off to OrderService.
- Cabinet item pooling scene instantiates catalog descriptors once and recycles nodes to avoid runtime allocation spikes.
- Session HUD layout adapts joystick/button placement with safe-area padding for portrait and landscape modes.

### Validation Status
- GUT tests: **Pass** (`./scripts/godot-cli.sh --headless --run res://tests/gut/test_runner.tscn`).

### File List
- `autoload/order_service.gd`
- `autoload/signal_hub.gd`
- `project.godot`
- `resources/curves/claw_joint_profiles.tres`
- `resources/curves/input_curve_profiles.tres`
- `scenes/session/CabinetItemPool.tscn`
- `scenes/session/ClawCabinet.tscn`
- `scenes/session/ClawRig.tscn`
- `scenes/session/SessionRoot.tscn`
- `scripts/gameplay/cabinet_item_pool.gd`
- `scripts/gameplay/claw_input_controller.gd`
- `scripts/gameplay/claw_rig_solver.gd`
- `scripts/gameplay/session_root.gd`
- `scripts/godot-cli.sh`
- `scripts/ui/virtual_joystick.gd`
- `tests/gut/test_runner.gd`
- `tests/gut/unit/test_claw_input_controller.gd`
- `tests/gut/unit/test_claw_rig_solver.gd`
- `ui/components/VirtualJoystick.tscn`
- `docs/architecture/tech-stack.md`

### Change Log
- Added claw rig solver, input controller, pooling scene, and UI controls to SessionRoot, completing story 1.3 integration.
- Extended SignalHub and OrderService with claw delivery events and created new InputMap actions for virtual controls.
- Authored and integrated TDD coverage for controller/solver flows, taught the CLI wrapper to use the bundled Godot binary so headless tests run successfully in-sandbox, and refreshed the tech stack doc with the new workflow.
