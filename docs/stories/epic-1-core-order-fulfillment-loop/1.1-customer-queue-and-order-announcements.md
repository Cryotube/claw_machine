# Godot Story: Customer Queue & Order Announcements

**Epic:** Epic 1 – Core Order Fulfillment Loop  
**Story ID:** 1.1  
**Priority:** High  
**Points:** 5  
**Status:** Approved
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Implement the first slice of the service loop by introducing animated cat patrons, order announcements, and patience feedback tied to `OrderService` so the player can see incoming requests before engaging the claw. The work instantiates the `CustomerQueue` scene under `SessionRoot`, binds autoload services through `SignalHub`, and drives HUD components (`OrderBanner`, `PatienceMeter`) with typed signals aligned to the resource-driven order catalog.  
  
**Godot Implementation:** Using `CustomerQueue.tscn` and Control-based HUD components authored under `res://ui/components/`, all scripted in typed GDScript to follow architecture conventions (docs/architecture/high-level-architecture.md; docs/architecture/ui-component-system.md; docs/architecture/godot-development-conventions.md).  
**Performance Impact:** Minimal CPU/GPU impact when pooling patron nodes; must sustain 60+ FPS by reusing meshes, limiting animations, and leveraging signal-driven updates (docs/architecture/performance-and-security-considerations.md).

## Acceptance Criteria
### Functional Requirements
- Cat patrons spawn through `CustomerQueue` at configured intervals, enter the counter lane, and display patience meters tied to `OrderService` timers (docs/game-prd/requirements.md; docs/architecture/game-systems-components.md).
- Incoming orders trigger `SignalHub` events that populate `OrderBanner` with seafood name, icon, and tutorial hint from `OrderDefinition` resources (docs/architecture/game-data-models.md).
- Patience meters change state (pending → warning → critical) and emit haptic/audio cues before failure thresholds (docs/architecture/ui-component-system.md; docs/architecture/audio-architecture.md).
- Serving (mocked for now via debug action) hides the active customer, clears HUD indicators, and queues the next patron with fresh timers.
- Orientation swaps (portrait/landscape) retain HUD alignment and safe-area padding per UI architecture guidance (docs/architecture/ui-architecture.md).

### Technical Requirements
- Code follows typed GDScript best practices.
- Maintains 60+ FPS on all target devices (frame time <16.67ms).
- Object pooling implemented for spawned entities.
- Signals properly connected and cleaned up.
- GUT coverage >= 80%.
- Patience timers and order DTOs emitted via `SignalHub` remain deterministic and serialization friendly (docs/architecture/game-systems-components.md; docs/architecture/node-architecture-details.md).

### Game Design Requirements
- Patience meter color states match UX accessibility palette (docs/game-prd/requirements.md; docs/architecture/ui-component-system.md).
- Cat entry animations reflect persona mood cues and trigger corresponding VO/haptic feedback.
- Order announcement copy pulls localized strings through `LocalizationService` stub to support ENG/JP pipeline (docs/architecture/ui-component-system.md).

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**
- `res://scenes/session/CustomerQueue.tscn` – Scene composing spawn lane, marker paths, patience widget anchors, and audio emitters (docs/architecture/high-level-architecture.md).
- `res://ui/components/OrderBanner.tscn` – HUD control showing seafood request, timer state, and tutorial hint (docs/architecture/ui-component-system.md).
- `res://ui/components/PatienceMeter.tscn` – Control node with color/animation states bound to timer percentages (docs/architecture/ui-architecture.md).

**New Scripts:**
- `res://scripts/gameplay/customer_queue.gd` – Manages spawn timers, animation states, and pooling (docs/architecture/game-systems-components.md).
- `res://scripts/ui/order_banner.gd` – Binds order DTOs to Control nodes with localization hooks (docs/architecture/ui-component-system.md).
- `res://scripts/ui/patience_meter.gd` – Animates meter thresholds and emits warnings through `SignalHub` (docs/architecture/node-architecture-details.md).

**Modified Files:**
- `res://autoload/OrderService.gd` – Emit `order_requested` and `order_cleared` signals with DTO payloads (docs/architecture/game-systems-components.md).
- `res://autoload/SignalHub.gd` – Register new channels for customer and HUD events (docs/architecture/high-level-architecture.md).
- `res://scenes/session/SessionRoot.tscn` – Add `CustomerQueue` instance and exported references to HUD components (docs/architecture/high-level-architecture.md).

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# customer_queue.gd
class_name CustomerQueue
extends Node3D

@export var customer_scene: PackedScene
@export var spawn_markers: Array[Node3D]
@onready var _order_service: OrderService = OrderService.get_instance()
@onready var _signal_hub: SignalHub = SignalHub.get_instance()

var _active_customers: Array[Node3D] = []
var _pool: Array[Node3D] = []

signal customer_spawned(order_id: String, patience_seconds: float)

func _ready() -> void:
    _signal_hub.order_fulfilled.connect(_on_order_fulfilled)
    _signal_hub.order_failed.connect(_on_order_failed)
    _order_service.order_requested.connect(_spawn_customer)

func _spawn_customer(dto: OrderRequestDto) -> void:
    var customer := _borrow_customer()
    customer.setup(dto)
    _active_customers.append(customer)
    emit_signal("customer_spawned", dto.id, dto.patience_seconds)

func _borrow_customer() -> Node3D:
    if _pool.is_empty():
        var instance := customer_scene.instantiate()
        add_child(instance)
        return instance
    return _pool.pop_back()
```

### Scene Specifications
- Instatiate `CustomerQueue` under `SessionRoot` alongside `ClawCabinet` and `SessionHUD`, wiring exported references through typed properties (docs/architecture/high-level-architecture.md).
- `CustomerQueue` contains `Path3D` for arrival animation, `AnimationPlayer` for persona clips, and `AudioStreamPlayer3D` for VO cues.
- `SessionHUD.tscn` references `OrderBanner` and `PatienceMeter` in a dedicated `CanvasLayer`, anchored per orientation guidelines (docs/architecture/ui-architecture.md).

### Signal Flow & Event Handling
- `OrderService` emits `order_requested(OrderRequestDto)` → `SignalHub.order_requested` → `CustomerQueue` spawn + `OrderBanner` update.
- `PatienceMeter` broadcasts `patience_warning` and `patience_critical` back through `SignalHub` for audio/haptic triggers (docs/architecture/audio-architecture.md).
- `SignalHub.order_cleared` resets HUD controls and returns customer node to pool.

### Language Strategy
- All new gameplay and HUD scripts use typed GDScript for determinism and static typing gains (docs/architecture/tech-stack.md; docs/architecture/godot-development-conventions.md).
- DTO definitions placed in `res://scripts/services/dto/order_request_dto.gd` for reuse by future stories while keeping serialization consistent (docs/architecture/game-data-models.md).

### Input Configuration
- No direct player input handled here; rely on `SignalHub` debug command to simulate order fulfillment until claw controls ship in Story 1.3 (docs/architecture/input-system-architecture.md).

### UI Implementation
- `OrderBanner` uses Control hierarchy with responsive anchors and theme classes from base UI theme (docs/architecture/ui-architecture.md).
- Localized text pulled with `LocalizationService.tr_context` to support ENG/JP shipping requirement (docs/architecture/ui-component-system.md).
- Accessibility-friendly color palette sourced from UX spec, with colorblind variants toggled via `Settings` autoload (docs/architecture/ui-component-system.md).

### Resource Pipeline
- Reads `OrderDefinition` and `CustomerProfile` resources from `res://resources/data/` to populate DTOs and animations (docs/architecture/game-data-models.md).
- Patience decay curves loaded from `res://resources/data/patience_curves.tres` per resource architecture notes (docs/architecture/node-architecture-details.md).
- Customer models pulled from pooled `CabinetItemDescriptor` references to avoid duplicate instantiation (docs/architecture/node-architecture-details.md).

### Performance Targets
- Maintain frame time <16.67 ms by preloading customer meshes, limiting concurrent animations to `max_concurrent_cats` as defined in `WaveConfig` (docs/architecture/performance-and-security-considerations.md).
- Ensure object pooling prevents allocation spikes when consecutive orders spawn rapidly.
- Use Godot profiler to verify memory footprint remains under 1.4 GB / 1.6 GB budgets for iOS/Android (docs/architecture/performance-and-security-considerations.md).

### Platform Considerations
- HUD safe-areas respect device notches and posture changes using orientation adapters (docs/architecture/ui-architecture.md).
- Haptic cues toggled off automatically when platform lacks vibration permission (docs/game-prd/requirements.md; docs/architecture/audio-architecture.md).

### TDD Requirements
- Author GUT tests for `CustomerQueue` spawn cadence, pooling reuse, and signal emission order (docs/architecture/test-strategy-and-standards.md).
- Add GUT tests for `OrderBanner` and `PatienceMeter` to validate state transitions given DTO fixtures.
- Integration test loads `SessionRoot` with autoload mocks to simulate order lifecycle entirely headless via `scripts/godot-cli.sh --headless --test`.
- Record baseline profiler metrics in test logs for regression tracking.

## Tasks / Subtasks
1. **Design DTOs and Signals (AC: 1, 2)** – Define `OrderRequestDto`, extend `OrderService` with typed signals, update `SignalHub` channels. [Source: docs/architecture/game-systems-components.md; docs/architecture/game-data-models.md]
2. **Build Customer Queue Scene (AC: 1, 3)** – Author `CustomerQueue.tscn`, configure spawn paths, pooling, and animation hooks per node conventions. [Source: docs/architecture/high-level-architecture.md; docs/architecture/node-architecture-details.md]
3. **Implement HUD Components (AC: 2, 5)** – Create `OrderBanner` and `PatienceMeter` controls with responsive anchors and localization support. [Source: docs/architecture/ui-architecture.md; docs/architecture/ui-component-system.md]
4. **Wire Signals and Autoloads (AC: 1, 2, 3)** – Connect service events through `SignalHub`, ensure cleanup on queue reset, add debug signal to simulate fulfillment. [Source: docs/architecture/game-systems-components.md]
5. **Add TDD Coverage (AC: 1–4)** – Write GUT tests for queue spawn cadence, HUD state transitions, and signal flow before implementation; maintain ≥80% coverage. [Source: docs/architecture/test-strategy-and-standards.md]
6. **Performance Validation (AC: 1, 3)** – Run headless tests plus profiler capture to confirm frame time under 16.67 ms and no memory leaks. [Source: docs/architecture/performance-and-security-considerations.md]
7. **Documentation & Review (AC: 1–5)** – Update story changelog, note decisions in Dev Agent Record, attach profiler snapshots for QA. [Source: docs/architecture/core-game-workflows.md]

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**
- `res://tests/gut/unit/test_customer_queue.gd`
- `res://tests/gut/unit/test_order_banner.gd`
- Coverage Target: 80% minimum

**Test Scenarios (Write First - Red Phase):**
- Spawn cadence respects `WaveConfig.max_concurrent_cats` and reuses pool entries.
- `OrderBanner` transitions through pending/warning/critical states given timer deltas.
- Patience warning signal triggers within 2 seconds of threshold crossing.
- Performance test: Frame time < 16.67 ms during simulated three-cat overlap.

### Game Testing
1. Load `SessionRoot` in editor, trigger `order_requested` three times via debug panel.
   - Expected: Customers spawn, patience meters animate, audio/haptics fire warnings at thresholds.
   - Performance: Must maintain 60+ FPS
   - Profiler Check: Frame time < 16.67 ms
   - Language Validation: GDScript events run without warnings

2. Simulate order fulfillment via debug command.
   - Expected: HUD clears, customer despawns, queue advances, signals deregister cleanly.
   - Signal Flow: `order_cleared` emitted once, no duplicate events.
   - Memory: No growth in allocated nodes post-reset
   - Object Pools: Verify pooling active

### Performance Tests
**Godot Profiler Metrics (Mandatory):**
- Frame rate: 60+ FPS consistently (FAIL if below)
- Frame time: < 16.67 ms average
- Physics frame: < 4 ms
- Memory usage: < 1400 MB iOS / 1600 MB Android
- Draw calls: < 700 (HUD + queue baseline)
- Object pools: Active and recycling properly
- GDScript static typing: Verified (10–20% perf gain)
- Patience meter shader: confirm no additional passes beyond budget

## Dependencies
**Story Dependencies:**
- None; first story in Epic 1.

**Godot System Dependencies:**
- Node: `SessionRoot` must instantiate `SignalHub` and autoload singletons before queue initialization (docs/architecture/high-level-architecture.md).
- Autoload: `OrderService`, `SignalHub`, `Settings`, `AudioDirector` configured (docs/architecture/game-systems-components.md).
- Language: Typed GDScript enabled in project settings per conventions (docs/architecture/godot-development-conventions.md).

**Resource Dependencies:**
- Resource Type: `.tres`
- Asset: `order_catalog.tres`, `customer_profiles.tres`, `patience_curves.tres`
- Location: `res://resources/data/`
- Import Settings: Validate via resource loaders and ensure localization strings exist

## Definition of Done
- All acceptance criteria met
- TDD followed (tests written first, then implementation)
- GUT tests passing (GDScript) with 80%+ coverage
- Performance: 60+ FPS maintained on all platforms
- Static typing used in all GDScript
- Object pooling active for spawned entities
- Signals properly connected and cleaned up
- No GDScript warnings
- Node hierarchy follows architecture
- Resources (.tres) configured properly
- Export templates tested
- Tutorial debug skip toggles documented for QA sign-off

## Notes
**Godot Implementation Notes:**
- Language Choice: GDScript because queue logic, HUD binding, and signal orchestration live in gameplay layer and benefit from rapid iteration with static typing (docs/architecture/tech-stack.md).
- Node Architecture: Customer queue isolates spawn logic under `SessionRoot` to keep scenes modular and testable (docs/architecture/high-level-architecture.md).
- Signal Pattern: Centralize traffic through `SignalHub` to keep services decoupled and testable (docs/architecture/game-systems-components.md).

**Performance Decisions:**
- Static Typing: Enforced across new scripts for 10–20% gain and better editor tooling (docs/architecture/godot-development-conventions.md).
- Single-language discipline: keep implementation purely in typed GDScript per updated architecture guidance.
- Object Pooling: Required for customer avatars to avoid GC spikes and maintain 60 FPS (docs/architecture/node-architecture-details.md).

**Future Optimizations:**
- Consider migrating patience meter shader to a shared material with uniforms if HUD expands.
- Add deterministic customer spawn recordings for regression testing once claw loop is online.
- Integrate analytics events for patience warnings to tune difficulty in Epic 2.
