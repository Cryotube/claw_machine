# Godot Story: Score Tracking & Persistence

**Epic:** Epic 2 – Failure Handling & Progression Scaling  
**Story ID:** 2.3  
**Priority:** High  
**Points:** 5  
**Status:** Draft  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Persist run statistics (score, combo, high score) and expose them to HUD and analytics so players retain progress between sessions. The story encrypts saves, records run summaries, and integrates with wave analytics without blocking gameplay. [Source: game-prd/requirements.md#functional][Source: architecture/data-persistence-architecture.md#save-data-structure][Source: architecture/game-systems-components.md#core-systems]

**Godot Implementation:** Extend `GameState`, `PersistenceService`, and `SessionHUD` to capture run data, encrypt saves via AES-256, and render high score updates in real time. [Source: architecture/save-system-implementation.md#save-system-implementation][Source: architecture/high-level-architecture.md#high-level-overview][Source: architecture/ui-component-system.md#data-binding]

**Performance Impact:** Use asynchronous persistence writes, limit JSON payload sizes, and debounce saves to maintain <16.67 ms frame time. [Source: architecture/data-persistence-architecture.md#persistence-strategy][Source: architecture/performance-and-security-considerations.md#performance-budgets][Source: architecture/analytics-integration.md#implementation]

## Acceptance Criteria
### Functional Requirements
- Session scores, combo peak, lives remaining, and wave reached persist via encrypted save after each wave and on game over. [Source: architecture/data-persistence-architecture.md#save-data-structure][Source: architecture/save-system-implementation.md#save-system-implementation]
- HUD displays current score, high score, and personal best delta in real time. [Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-component-system.md#data-binding]
- Analytics logs `run_summary` with final score, duration, and failure cause to support balancing. [Source: architecture/analytics-integration.md#event-design]
- Loading save on boot restores high score, tutorial completion, and accessibility settings without warnings. [Source: architecture/data-persistence-architecture.md#save-data-structure][Source: architecture/ui-component-system.md#localization-workflow]

### Technical Requirements
- Typed GDScript for persistence interfaces; encryption handled by `PersistenceService`. [Source: architecture/godot-development-conventions.md#best-practices][Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Maintains 60+ FPS during save operations using async worker thread. [Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Object pooling maintained for scoreboard animations (no new allocations per update). [Source: architecture/node-architecture-details.md#node-patterns]
- Signals fire once per save completion; error handling routes through `SignalHub`. [Source: architecture/game-systems-components.md#core-systems]
- GUT coverage ≥ 80% for persistence serialization/deserialization. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- Save payload versioned with migration helpers. [Source: architecture/data-persistence-architecture.md#save-data-structure]

### Game Design Requirements
- High score celebrations align with UI style (glow, audio sting) without overwhelming gameplay. [Source: front-end-spec.md#session_hudtscn][Source: architecture/audio-architecture.md#system-design]
- Game over summary displays run stats and prompts replay within 5 seconds. [Source: docs/game-prd/epics/epic-2-progression-and-failstates.md#description][Source: front-end-spec.md#fulfill-customer-order-during-score-run]
- Persistence respects cozy tone—no intrusive dialogs—yet communicates new personal bests clearly. [Source: game-prd/goals-and-background-context.md#goals][Source: architecture/ui-architecture.md#ui-system-selection]

## Technical Specifications
### Files to Create/Modify
**New Scripts:**
- `res://scripts/services/run_summary_service.gd` – Aggregates metrics, triggers persistence, and exposes summary DTOs. [Source: architecture/game-systems-components.md#core-systems][Source: architecture/data-persistence-architecture.md#persistence-strategy]
- `res://scripts/ui/high_score_panel.gd` – Displays personal bests, delta animations, and localization. [Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-component-system.md#data-binding]

**Modified Files:**
- `res://autoload/GameState.gd` – Track running totals, combo peak, and pass snapshot to persistence layer. [Source: architecture/game-systems-components.md#core-systems]
- `res://scripts/services/persistence_service.gd` – Implement AES-256 save, HMAC validation, and worker thread writes. [Source: architecture/data-persistence-architecture.md#persistence-strategy][Source: architecture/save-system-implementation.md#save-system-implementation]
- `res://autoload/SignalHub.gd` – Add `run_summary_ready` and `save_failed` signals. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- `res://scripts/ui/session_hud.gd` – Update high score UI, show best delta, and animate combos. [Source: front-end-spec.md#session_hudtscn]
- `res://scripts/services/analytics_stub.gd` – Append `run_summary` events. [Source: architecture/analytics-integration.md#event-design]
- `res://scripts/ui/game_over_panel.gd` – Render summary data and provide replay prompts. [Source: docs/game-prd/epics/epic-2-progression-and-failstates.md#outcomes]

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# run_summary_service.gd
class_name RunSummaryService
extends Node

@onready var _persistence: PersistenceService = PersistenceService.get_instance()
@onready var _game_state: GameState = GameState.get_instance()
@onready var _analytics: AnalyticsStub = AnalyticsStub.get_instance()
@onready var _signal_hub: SignalHub = SignalHub.get_instance()

func record_wave_end() -> void:
    var snapshot := _game_state.create_snapshot()
    _persistence.save_game_async(snapshot)
    _analytics.enqueue_run_snapshot(snapshot)

func load_snapshot() -> void:
    var snapshot := _persistence.load_game()
    if snapshot:
        _game_state.restore_snapshot(snapshot)
        _signal_hub.run_summary_ready.emit(snapshot)
```
The service aggregates game data, persists asynchronously, and informs analytics without blocking the main thread. [Source: architecture/save-system-implementation.md#save-system-implementation][Source: architecture/data-persistence-architecture.md#persistence-strategy][Source: architecture/game-systems-components.md#core-systems]

### Implementation Strategy
Leverage `PersistenceService` worker thread to handle encryption/decryption, keeping gameplay responsive while saves occur. [Source: architecture/data-persistence-architecture.md#persistence-strategy]  
Capture run summary DTOs at wave end and on game over to guarantee data even if the app quits unexpectedly. [Source: architecture/game-systems-components.md#core-systems]  
Mirror summary data to analytics for balancing, ensuring payload shape matches event schema. [Source: architecture/analytics-integration.md#event-design]

### Tasks / Subtasks
1. **Define Run Snapshot DTO (AC: 1, 4)** – Include score, high score, combo peak, wave reached, total duration, failure cause. [Source: architecture/game-data-models.md#game-data-models]
2. **Implement Persistence Writes (AC: 1)** – Use AES-256 encryption, HMAC validation, and worker thread to save snapshots. [Source: architecture/data-persistence-architecture.md#save-data-structure][Source: architecture/save-system-implementation.md#save-system-implementation]
3. **Update HUD/Game Over (AC: 2, 3)** – Display high score, personal best deltas, and summary overlay. [Source: front-end-spec.md#session_hudtscn][Source: docs/game-prd/epics/epic-2-progression-and-failstates.md#outcomes]
4. **Analytics Integration (AC: 3)** – Emit `run_summary` event with schema-compliant payload. [Source: architecture/analytics-integration.md#event-design]
5. **TDD & Error Handling (AC: 1–4)** – Write GUT tests for serialization/deserialization, simulate corrupt save fallback, and confirm UI updates on load. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**
- `res://tests/gut/unit/test_run_summary_service.gd`
- `res://tests/gut/unit/test_persistence_service.gd`
- Coverage Target: 80% minimum. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]

**Test Scenarios (Write First - Red Phase):**
- Snapshot serialization/deserialization preserves score, combo, wave. [Source: architecture/data-persistence-architecture.md#save-data-structure]
- Corrupt save triggers fallback and emits `save_failed`. [Source: architecture/save-system-implementation.md#save-system-implementation]
- Analytics payload matches `run_summary` schema. [Source: architecture/analytics-integration.md#event-design]

### Game Testing
1. Complete a run, exit to menu, relaunch project.  
   - Expected: High score and settings restored; HUD shows correct delta; run summary saved. [Source: architecture/data-persistence-architecture.md#save-data-structure][Source: front-end-spec.md#session_hudtscn]  
   - Performance: Saves occur asynchronously; no frame drops. [Source: architecture/data-persistence-architecture.md#persistence-strategy]
2. Force-save failure (simulate I/O error).  
   - Expected: `save_failed` signal prompts unobtrusive toast, analytics logs error, fallback snapshot used. [Source: architecture/save-system-implementation.md#save-system-implementation][Source: architecture/analytics-integration.md#event-design]

### Performance Tests
**Godot Profiler Metrics (Mandatory):**
- Frame rate: 60+ FPS while saving at wave boundaries. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Frame time: <16.67 ms average during save operations. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Physics frame: <4 ms (persistence runs off main thread). [Source: architecture/physics-configuration.md#physics-settings]
- Memory usage: <1400 MB iOS / 1600 MB Android. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Draw calls: <720 including summary overlays. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]
- Object pools: HUD animations reuse cached nodes. [Source: architecture/node-architecture-details.md#node-patterns]
- GDScript static typing verified. [Source: architecture/godot-development-conventions.md#best-practices]
- Save duration: <50 ms on worker thread (monitored). [Source: architecture/data-persistence-architecture.md#persistence-strategy]

## Dependencies
**Story Dependencies:**
- 2.2 – Wave Pacing & Difficulty Scaling (summary references wave metrics). [Source: docs/stories/epic-2-progression-and-failstates/2.2-wave-pacing-and-difficulty-scaling.md]
- Epic 1 scoring story establishes score/combo pipeline consumed here. [Source: docs/stories/epic-1-core-order-fulfillment-loop/1.4-order-resolution-scoring-and-reset.md]

**Godot System Dependencies:**
- Node: `SessionRoot` instantiates `GameState`, `PersistenceService`, `AnalyticsStub`, `SessionHUD`. [Source: architecture/high-level-architecture.md#high-level-overview]
- Autoload: `GameState`, `PersistenceService`, `SignalHub`, `AnalyticsStub`, `Settings`. [Source: architecture/game-systems-components.md#core-systems][Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Language: Typed GDScript enforced. [Source: architecture/godot-development-conventions.md#workflow-conventions]

**Resource Dependencies:**
- Resource Type: `.tres`
- Asset: `save_schema_v1.tres`, `summary_strings.csv`
- Location: `res://resources/data/`, `res://resources/i18n/`
- Import Settings: Ensure localization csv validated via CI pipeline. [Source: architecture/ui-component-system.md#localization-workflow]

## Definition of Done
- All acceptance criteria met. [Source: docs/game-prd/epics/epic-2-progression-and-failstates.md#stories]
- TDD followed (tests written first, then implementation). [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GUT tests passing with 80%+ coverage. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GoDotTest passing (if applicable). [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]
- Performance: 60+ FPS maintained. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Static typing used in all GDScript. [Source: architecture/godot-development-conventions.md#best-practices]
- Object pooling active for HUD effects. [Source: architecture/node-architecture-details.md#node-patterns]
- Signals properly connected and cleaned up. [Source: architecture/game-systems-components.md#core-systems]
- No GDScript warnings. [Source: architecture/godot-development-conventions.md#workflow-conventions]
- Node hierarchy follows architecture. [Source: architecture/high-level-architecture.md#high-level-overview]
- Resources configured properly. [Source: architecture/node-architecture-details.md#resource-architecture]
- Export templates tested. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Documentation updated. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Save/load manually verified with encrypted payload. [Source: architecture/save-system-implementation.md#save-system-implementation]

## Notes
**Godot Implementation Notes:**
- Language Choice: GDScript ensures persistence integrates smoothly with existing services while honoring single-language strategy. [Source: architecture/godot-development-conventions.md#best-practices]
- Node Architecture: `RunSummaryService` attached under `SessionRoot` so autoloads remain accessible and testable. [Source: architecture/high-level-architecture.md#high-level-overview]
- Signal Pattern: Persistence and analytics events routed through `SignalHub` for modular responses. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- Localization integrated for summary text via CSV pipeline. [Source: architecture/ui-component-system.md#localization-workflow]

**Performance Decisions:**
- Static Typing: Enforced for snapshots and persistence classes to minimize GC. [Source: architecture/godot-development-conventions.md#best-practices]
- Object Pooling: HUD animations reuse existing nodes. [Source: architecture/node-architecture-details.md#node-patterns]
- Asynchronous saves ensure gameplay thread unaffected. [Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Save payload trimmed to essential fields to reduce I/O. [Source: architecture/performance-and-security-considerations.md#performance-budgets]

**Future Optimizations:**
- Add cloud sync hooks once network pipeline approved. [Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Introduce run history carousel on game over for player insights. [Source: front-end-spec.md#session_hudtscn]
- Expand analytics to correlate device telemetry with score trends. [Source: architecture/analytics-integration.md#implementation]
