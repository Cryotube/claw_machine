# Godot Story: Patience Failure Consequences

**Epic:** Epic 2 – Failure Handling & Progression Scaling  
**Story ID:** 2.1  
**Priority:** High  
**Points:** 5  
**Status:** Approved
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Deliver the visual, audio, and systemic feedback when a cat’s patience expires or the wrong item is served. The feature reduces lives, plays failure reactions, logs analytics, and primes the queue and cabinet for the next attempt without destabilizing performance. [Source: game-prd/requirements.md#functional][Source: architecture/game-systems-components.md#core-systems][Source: architecture/analytics-integration.md#event-design]

**Godot Implementation:** Extend `OrderService`, `GameState`, `AudioDirector`, and `SessionHUD` to react to failure signals, while `CustomerQueue` handles animation and despawn sequencing aligned with architecture guidance. [Source: architecture/gameplay-systems-architecture.md#gameplay-components][Source: architecture/audio-architecture.md#system-design][Source: architecture/high-level-architecture.md#high-level-overview]

**Performance Impact:** Execute failure reactions using pooled nodes, deferred HUD updates, and preloaded audio to sustain sub-16.67 ms frames. [Source: architecture/performance-and-security-considerations.md#performance-budgets][Source: architecture/node-architecture-details.md#node-patterns][Source: architecture/ui-component-system.md#data-binding]

## Acceptance Criteria
### Functional Requirements
- Patience expiry triggers life decrement, failure animation, haptic cue, and analytics event `order_failed` with reason `timeout`. [Source: architecture/game-systems-components.md#system-interaction-wave-flow][Source: architecture/audio-architecture.md#system-design][Source: architecture/analytics-integration.md#event-design]
- Serving wrong item emits failure flow with reason `mismatch`, resets combo to zero, and displays corrective highlight for the correct seafood. [Source: front-end-spec.md#fulfill-customer-order-during-score-run][Source: architecture/game-systems-components.md#system-interaction-session-core][Source: architecture/analytics-integration.md#event-design]
- After any failure, `CustomerQueue` despawns the active cat, spawns the next patron, and resets cabinet/patience state via pooled nodes within 500 ms. [Source: architecture/gameplay-systems-architecture.md#gameplay-components][Source: architecture/node-architecture-details.md#node-patterns]
- HUD and score widgets update lives, combo, and warning banners in the same frame as failure resolution. [Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-component-system.md#data-binding]

### Technical Requirements
- Typed GDScript used for all failure handling logic. [Source: architecture/godot-development-conventions.md#best-practices]
- Maintains 60+ FPS during chained failures. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Object pooling applied to failure VFX, cat reactions, and HUD warning overlays. [Source: architecture/node-architecture-details.md#node-patterns]
- Signals remain debounced; no duplicate failure emissions per order. [Source: architecture/game-systems-components.md#core-systems]
- GUT coverage ≥ 80% for failure flows. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- Analytics queue writes remain asynchronous (<5 ms). [Source: architecture/analytics-integration.md#implementation]

### Game Design Requirements
- Failure animations reflect cat persona mood and match VO/haptics cues. [Source: architecture/audio-architecture.md#system-design][Source: game-prd/goals-and-background-context.md#goals]
- Warning banners follow accessibility palette and remain legible in portrait/landscape. [Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-architecture.md#ui-system-selection]
- Grace period after failure (2 s) before patience resumes ensures player recovery. [Source: front-end-spec.md#fulfill-customer-order-during-score-run][Source: architecture/gameplay-systems-architecture.md#gameplay-overview]

## Technical Specifications
### Files to Create/Modify
**New Scripts:**
- `res://scripts/gameplay/failure_reaction_controller.gd` – Coordinates cat animations, VFX, and haptics on failure. [Source: architecture/gameplay-systems-architecture.md#gameplay-components][Source: architecture/audio-architecture.md#system-design]
- `res://scripts/ui/failure_banner.gd` – HUD control for warning copy, countdown, and orientation-safe layout. [Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-component-system.md#component-library]

**Modified Files:**
- `res://autoload/OrderService.gd` – Emit failure payloads with cause, combo reset, and patience restart window. [Source: architecture/game-systems-components.md#core-systems]
- `res://autoload/GameState.gd` – Track lives, failure streak, and trigger analytics logging. [Source: architecture/game-systems-components.md#core-systems]
- `res://autoload/SignalHub.gd` – Add `order_failure_resolved` and `lives_updated` signals. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- `res://scripts/ui/session_hud.gd` – Display failure banner, animate life icons, and schedule queue reset. [Source: front-end-spec.md#session_hudtscn]
- `res://scripts/gameplay/customer_queue.gd` – Incorporate failure delay, reaction animation, and pooled despawn. [Source: architecture/gameplay-systems-architecture.md#gameplay-components]
- `res://scripts/services/analytics_stub.gd` – Support failure reasons and combo resets in payloads. [Source: architecture/analytics-integration.md#event-design]

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# failure_reaction_controller.gd
class_name FailureReactionController
extends Node

@export var reaction_pool: PackedScene
@export var audio_bus: StringName = &"VO"

@onready var _signal_hub: SignalHub = SignalHub.get_instance()
@onready var _audio: AudioDirector = AudioDirector.get_instance()

func _ready() -> void:
    _signal_hub.order_failed.connect(_on_order_failed)

func _on_order_failed(result: OrderResult) -> void:
    var reaction := _acquire_reaction(result.customer_profile_id)
    reaction.play_animation(&"impatient")
    _audio.play_failure(result.customer_profile_id)
    _emit_haptic(result)
```
The controller reuses pooled reactions, routes audio through `AudioDirector`, and keeps failure handling deterministic. [Source: architecture/audio-architecture.md#system-design][Source: architecture/node-architecture-details.md#node-patterns][Source: architecture/godot-development-conventions.md#best-practices]

### Implementation Strategy
Centralize failure logic inside `OrderService` so all systems consume a single payload, then fan out via `SignalHub` to HUD, queue, and analytics. [Source: architecture/game-systems-components.md#system-interaction-session-core]  
Reuse pools for cat reactions and overlays to avoid runtime allocations and keep the 60 FPS budget. [Source: architecture/node-architecture-details.md#node-patterns][Source: architecture/performance-and-security-considerations.md#performance-budgets]  
Apply TDD to validate life/score changes and analytics payloads before integrating with scenes. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

### Tasks / Subtasks
1. **Augment Failure Payloads (AC: 1, 2)** – Extend `OrderService` DTOs with `reason`, `wave_index`, and `combo_snapshot`. [Source: architecture/game-data-models.md#game-data-models]
2. **Implement Reaction Controller (AC: 1, 2)** – Hook animations, audio, and haptics via pooled nodes. [Source: architecture/audio-architecture.md#system-design][Source: architecture/node-architecture-details.md#node-patterns]
3. **Update HUD Feedback (AC: 2, 4)** – Add failure banner, life animation, and orientation-safe layout updates. [Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-architecture.md#ui-system-selection]
4. **Analytics Logging (AC: 1, 2, 4)** – Append failure events to AnalyticsStub, ensure asynchronous flushing, and write regression tests. [Source: architecture/analytics-integration.md#implementation]
5. **TDD & Profiling (AC: 1–4)** – Write GUT tests for life decrement, combo reset, and queue delay; capture profiler snapshot verifying <16.67 ms frames during failure cascades. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization][Source: architecture/performance-and-security-considerations.md#performance-budgets]

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**
- `res://tests/gut/unit/test_order_failure_flow.gd`
- `res://tests/gut/unit/test_failure_reaction_controller.gd`
- Coverage Target: 80% minimum. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]

**Test Scenarios (Write First - Red Phase):**
- Patience expiry decrements life, resets combo, schedules queue reset. [Source: architecture/gameplay-systems-architecture.md#gameplay-components]
- Wrong item failure emits corrective highlight signal once. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- Analytics payload contains correct reason and combo snapshot. [Source: architecture/analytics-integration.md#event-design]

### Game Testing
1. Allow patience to expire in editor.  
   - Expected: Failure animation, life decrement, warning banner, next cat spawns after delay. [Source: front-end-spec.md#fulfill-customer-order-during-score-run][Source: architecture/gameplay-systems-architecture.md#gameplay-components]  
   - Performance: Maintain ≥60 FPS; no GC spikes. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
2. Serve wrong item intentionally.  
   - Expected: Failure overlay indicates mismatch, highlight flashes correct item, analytics log records reason `mismatch`. [Source: architecture/analytics-integration.md#event-design][Source: front-end-spec.md#fulfill-customer-order-during-score-run]

### Performance Tests
**Godot Profiler Metrics (Mandatory):**
- Frame rate: 60+ FPS during rapid failure streak. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Frame time: <16.67 ms average. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Physics frame: <4 ms (failures occur outside solver). [Source: architecture/physics-configuration.md#physics-settings]
- Memory usage: <1400 MB iOS / 1600 MB Android. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Draw calls: <720 including failure overlays. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]
- Object pools: Reaction pool reuse confirmed (no new instantiation). [Source: architecture/node-architecture-details.md#node-patterns]
- GDScript static typing verified. [Source: architecture/godot-development-conventions.md#best-practices]
- Analytics logging completes asynchronously <5 ms. [Source: architecture/analytics-integration.md#implementation]

## Dependencies
**Story Dependencies:**
- 1.x stories provide queue, visualization, claw solver, and scoring; this story layers failure handling atop them. [Source: docs/stories/epic-1-core-order-fulfillment-loop/1.4-order-resolution-scoring-and-reset.md]

**Godot System Dependencies:**
- Node: `SessionRoot` must instantiate `OrderService`, `GameState`, `SessionHUD`, `CustomerQueue`, `AudioDirector`. [Source: architecture/high-level-architecture.md#high-level-overview]
- Autoload: `OrderService`, `GameState`, `SignalHub`, `AnalyticsStub`. [Source: architecture/game-systems-components.md#core-systems]
- Language: Typed GDScript enforced. [Source: architecture/godot-development-conventions.md#workflow-conventions]

**Resource Dependencies:**
- Resource Type: `.tres`
- Asset: `cat_reaction_profiles.tres`, `failure_vfx_pool.tscn`, `warning_strings.csv`  
- Location: `res://resources/data/`, `res://ui/components/`  
- Import Settings: Ensure VFX textures follow mobile compression presets. [Source: architecture/node-architecture-details.md#resource-architecture]

## Definition of Done
- All acceptance criteria met. [Source: game-prd/epics/epic-2-progression-and-failstates.md#stories]
- TDD followed (tests written first, then implementation). [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GUT tests passing (GDScript) with 80%+ coverage. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GoDotTest passing (C#) with 80%+ coverage (N/A if unused). [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]
- Performance: 60+ FPS maintained on all platforms. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Static typing used in all GDScript. [Source: architecture/godot-development-conventions.md#best-practices]
- Object pooling active for failure effects. [Source: architecture/node-architecture-details.md#node-patterns]
- Signals properly connected and cleaned up. [Source: architecture/game-systems-components.md#core-systems]
- No GDScript warnings. [Source: architecture/godot-development-conventions.md#workflow-conventions]
- Node hierarchy follows architecture. [Source: architecture/high-level-architecture.md#high-level-overview]
- Resources configured properly. [Source: architecture/node-architecture-details.md#resource-architecture]
- Export templates tested. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Documentation updated. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Analytics entries verified for failure reasons. [Source: architecture/analytics-integration.md#implementation]

## Notes
**Godot Implementation Notes:**
- Language Choice: GDScript keeps failure/state updates aligned with existing services. [Source: architecture/godot-development-conventions.md#best-practices]
- Node Architecture: Reaction controller attached under `CustomerQueue` for localized animation control. [Source: architecture/gameplay-systems-architecture.md#gameplay-components]
- Signal Pattern: `SignalHub` mediates failure notifications so HUD, audio, and analytics remain decoupled. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- Warning text uses localization pipeline for ENG/JP support. [Source: architecture/ui-component-system.md#localization-workflow]

**Performance Decisions:**
- Static Typing: Enforced for failure pipeline to minimize GC pressure. [Source: architecture/godot-development-conventions.md#best-practices]
- C# Usage: Not required; GDScript sufficient. [Source: architecture/game-systems-components.md#core-systems]
- Object Pooling: Reaction prefabs preloaded to avoid runtime instantiation. [Source: architecture/node-architecture-details.md#node-patterns]
- Deferred HUD updates prevent layout thrash. [Source: architecture/ui-component-system.md#data-binding]

**Future Optimizations:**
- Add designer-tunable cooldown on warning banners. [Source: architecture/node-architecture-details.md#resource-architecture]
- Introduce analytics tagging for repeated failures to inform difficulty tuning. [Source: architecture/analytics-integration.md#event-design]
- Evaluate camera shake for future intensity toggle while respecting motion comfort. [Source: game-prd/goals-and-background-context.md#goals]

## Dev Agent Record
### Agent Model Used
- Carmack (Game Developer)

### Debug Log
- Loaded core architecture references plus Godot game dev pack defaults before story start; noted missing `source-tree.md` in config.
- Authored failing GUT specs covering failure payloads, reaction pooling, and HUD banner visibility prior to implementation.
- Extended `OrderService`, `GameState`, `SignalHub`, and analytics pipeline to carry failure reason, combo snapshot, failure streak, and restart window metadata.
- Refactored `CustomerQueue` with deferred release pipeline, SceneTreeTimer management, and `order_failure_resolved` broadcast to keep pooled customers deterministic.
- Introduced `FailureReactionController` with reusable effect pool, audio cues, and queue coordination; added typed `SessionHUD` orchestrator plus `FailureBanner` control with safe-area handling.
- Updated `SessionRoot` scene wiring and score panel flash animation, ensuring safe-area updates route through new HUD layer.
- Verified automated coverage and performance budgets via `./scripts/run-headless-checks.sh` (GUT suite + customer queue benchmark) in headless Godot.

### Completion Notes
- Failure pipeline now emits enriched payloads consumed by HUD, analytics, and reaction systems with typed GDScript throughout.
- `CustomerQueue` delays despawn via pooled animations yet respawns within the 500 ms SLA, signaling completion through the hub.
- New failure banner surfaces reason/accessibility copy during the 2 s grace window and resets automatically; score panel flashes lives on failure.
- Reaction controller reuses pooled VFX/audio, plays mismatch/timeout cues, and hands off defer timing to queue without GC churn.

### Validation Status
- GUT suite: `./scripts/run-headless-checks.sh` → “All 17 tests passed” (headless Godot 4.5, CA trust warning only).
- Performance benchmark: same script → customer queue benchmark averages ~6.9 ms/frame (≤16.67 ms target).

### File List
- `autoload/order_service.gd`
- `autoload/game_state.gd`
- `autoload/signal_hub.gd`
- `scripts/services/order_resolution_pipeline.gd`
- `scripts/gameplay/customer_queue.gd`
- `scripts/gameplay/failure_reaction_controller.gd`
- `scripts/gameplay/session_root.gd`
- `scripts/ui/failure_banner.gd`
- `scripts/ui/session_hud.gd`
- `scripts/ui/session_score_panel.gd`
- `scenes/session/SessionRoot.tscn`
- `tests/gut/unit/test_order_failure_flow.gd`
- `tests/gut/unit/test_failure_reaction_controller.gd`
- `tests/gut/unit/test_failure_banner.gd`

### Change Log
- Augmented failure payload, game state, and analytics wiring to include reason, combo snapshot, restart window, and failure streak tracking.
- Implemented failure reaction controller, HUD banner, and session HUD coordination with pooled effects, lives flash, and safe-area updates.
- Updated customer queue to support deferred despawn with timers and new `order_failure_resolved` signal while preserving pooling semantics.
