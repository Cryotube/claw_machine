# Godot Story: Audio & Haptics Polish

**Epic:** Epic 2 – Failure Handling & Progression Scaling  
**Story ID:** 2.4  
**Priority:** High  
**Points:** 3  
**Status:** Draft  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Replace placeholder audio logic with production-ready mix and haptic feedback that matches UX cues for patience states, successes, and failures. Implement audio buses, event routing, and device haptics, ensuring responsiveness on mobile hardware without degrading performance. [Source: docs/architecture/audio-architecture.md#system-design][Source: docs/game-prd.md#requirements][Source: docs/front-end-spec.md#screen-specifications]

**Godot Implementation:** Configure `AudioServer` buses, author `AudioDirector` event table, integrate success/failure stingers, and invoke haptic pulses through platform bridges. Coordinate with `SceneDirector` and HUD components for consistent feedback. [Source: docs/architecture/audio-mixing-configuration.md#mix-structure][Source: docs/architecture/performance-and-security-considerations.md#performance-budgets]

**Performance Impact:** Preload short audio streams, limit concurrent voices, and throttle haptic calls to maintain <16.67 ms frame time while avoiding thermal spikes. [Source: docs/architecture/performance-and-security-considerations.md#performance-budgets][Source: docs/architecture/audio-architecture.md#performance]

## Acceptance Criteria
### Functional Requirements
- `AudioDirector.play_event()` routes to named buses (`music`, `sfx`, `ui`) and respects mute/volume sliders. [Source: docs/architecture/audio-mixing-configuration.md#mix-structure]
- Patience warning/critical, success, failure, menu navigation, and tutorial steps each trigger distinct audio cues with fallbacks. [Source: docs/architecture/audio-architecture.md#system-design][Source: docs/front-end-spec.md#screen-specifications]
- Haptic feedback fires on key events (warning, success, failure, menu select) when enabled; disabled when toggle off or unsupported device. [Source: docs/game-prd.md#requirements][Source: docs/stories/epic-3-tutorial-and-hud/3.3-accessibility-toggles-and-localization-hooks.md#acceptance-criteria]
- Analytics logs audio/haptic usage metrics to inform tuning. [Source: docs/architecture/analytics-integration.md#event-design]

### Technical Requirements
- Audio buses configured in `project.godot` with limiter/compressor per mix spec; includes streaming assets under `res://resources/audio/`. [Source: docs/architecture/audio-mixing-configuration.md#mix-structure]
- `AudioDirector` stores last event, debounces rapid duplicates, and supports reduced-motion/audio fallback. [Source: docs/architecture/audio-architecture.md#system-design]
- Mobile haptics integrated via GDNative/Platform layer with graceful no-op on desktop. [Source: docs/architecture/external-integrations.md#mobile-bridges]
- Asset preload and playback verified to keep peak voice count ≤8; memory footprint logged. [Source: docs/architecture/performance-and-security-considerations.md#performance-budgets]
- GUT/unit tests mock `AudioDirector` to assert event mapping; integration test simulates toggle changes. [Source: docs/architecture/test-strategy-and-standards.md#godot-test-types-and-organization]

### Game Design Requirements
- Audio palette matches cozy underwater vibe, uses soft chimes for successes, muted bass for failures. [Source: docs/game-prd.md#goals-and-background-context][Source: docs/architecture/audio-architecture.md#system-design]
- Volume balances align with UX expectations; no cue exceeds -6 LUFS integrated within mix. [Source: docs/architecture/audio-mixing-configuration.md#mix-structure]
- Haptics intensity tuned for mobile comfort and respects reduced-intensity accessibility setting. [Source: docs/stories/epic-3-tutorial-and-hud/3.3-accessibility-toggles-and-localization-hooks.md#acceptance-criteria]

## Technical Specifications
### Files to Create/Modify
**New Resources:**
- `res://resources/audio/events.tres` – event-to-stream mapping.
- `res://resources/audio/bus_layout.tres` – exported bus configuration.
- `res://resources/haptics/haptic_profiles.tres` – per-event vibration patterns.

**Modified Files:**
- `res://autoload/audio_director.gd` – Implement event routing, preload cache, haptic hooks.
- `res://autoload/signal_hub.gd` – Emit `audio_event_played` for analytics.
- `res://scripts/services/order_resolution_pipeline.gd` – Trigger success/failure events with metadata.
- `res://scripts/ui/session_hud.gd` – Play HUD navigation cues.
- `project.godot` – Reference new audio bus layout.

### Testing
- Automated: `res://tests/gut/unit/test_audio_director.gd` mocking AudioServer, verifying bus routing, mute, debounce.
- Manual: Mix review with headphones/speakers, mobile haptic test on iPhone 12/Pixel 6, reduced-motion toggle verification.
- Performance: Capture audio voice count + frame time during multi-failure scenario; ensure no frame spikes >5 ms.

## Definition of Done
- Audio/haptic events implemented, tuned, and approved by UX + audio stakeholders.
- Volume sliders, mute toggles, and reduced-intensity options fully functional and persisted.
- Automated tests green; headless checks updated to include audio event assertions.
- QA gate recorded with PASS including device-specific notes.

## Notes
- Coordinate with localization team for cue naming to ensure translation consistency.
- Keep audio assets under 20 MB combined to stay within install budget.
- Document audio event table for future content drops (holiday packs, etc.).
