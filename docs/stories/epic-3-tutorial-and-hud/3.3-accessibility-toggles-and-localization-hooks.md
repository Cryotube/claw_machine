# Godot Story: Accessibility Toggles & Localization Hooks

**Epic:** Epic 3 – Tutorial Onboarding, HUD, and Accessibility  
**Story ID:** 3.3  
**Priority:** High  
**Points:** 5  
**Status:** Draft  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Implement accessibility toggles (colorblind palettes, haptic mute, camera sensitivity slider) and localization hooks so players can adjust experience within two taps and see UI update instantly in English or Japanese. [Source: game-prd/requirements.md#non-functional][Source: front-end-spec.md#godot-ui-component-library][Source: architecture/ui-component-system.md#localization-workflow]

**Godot Implementation:** Extend `Settings`, `AccessibilityService`, and `LocalizationService` to broadcast changes, update HUD/overlays, and persist preferences. [Source: architecture/game-systems-components.md#core-systems][Source: architecture/shader-guidelines.md#usage-patterns][Source: architecture/data-persistence-architecture.md#save-data-structure]

**Performance Impact:** Cache localization data, reuse shader/material resources, and debounce sensitivity updates to keep frame time <16.67 ms. [Source: architecture/performance-and-security-considerations.md#performance-budgets][Source: architecture/shader-guidelines.md#performance-guidelines][Source: architecture/ui-component-system.md#data-binding]

## Acceptance Criteria
### Functional Requirements
- Quick toggles update colorblind palettes, haptics, and camera sensitivity immediately across HUD and gameplay systems. [Source: architecture/ui-component-system.md#data-binding][Source: architecture/game-systems-components.md#core-systems][Source: architecture/shader-guidelines.md#usage-patterns]
- Localization switch (ENG/JP) updates HUD text, tutorial prompts, and pause overlay without restart. [Source: architecture/ui-component-system.md#localization-workflow][Source: front-end-spec.md#session_hudtscn]
- Accessibility settings persist via `PersistenceService` and reload on boot. [Source: architecture/data-persistence-architecture.md#save-data-structure][Source: architecture/save-system-implementation.md#save-system-implementation]
- Analytics logs toggle usage events for future UX improvements. [Source: architecture/analytics-integration.md#event-design]

### Technical Requirements
- Typed GDScript for settings services; changes broadcast through `SignalHub` and `UIManager`. [Source: architecture/game-systems-components.md#system-interaction-session-core][Source: architecture/godot-development-conventions.md#best-practices]
- 60+ FPS maintained during palette/material swaps and localization updates. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Object pooling for shader/material resources (no runtime instantiation). [Source: architecture/node-architecture-details.md#resource-architecture][Source: architecture/shader-guidelines.md#performance-guidelines]
- Signals debounced to avoid duplicate updates. [Source: architecture/game-systems-components.md#core-systems]
- GUT coverage ≥ 80% for settings serialization and localization binding. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- Localization CSV validation integrated with build pipeline. [Source: architecture/ui-component-system.md#localization-workflow]

### Game Design Requirements
- Accessibility toggles accessible within two taps from pause overlay and respect cozy visual design. [Source: game-prd/requirements.md#localization--accessibility-pipeline][Source: front-end-spec.md#pause_overlaytscn]
- Colorblind palettes maintain contrast and align with brand colors. [Source: front-end-spec.md#game-visual-style-guide][Source: architecture/shader-guidelines.md#usage-patterns]
- Camera sensitivity slider uses descriptive copy and helps meet input latency targets. [Source: architecture/input-system-architecture.md#input-handling-patterns][Source: game-prd/requirements.md#non-functional]

## Technical Specifications
### Files to Create/Modify
**New Scripts:**
- `res://scripts/services/accessibility_service.gd` – Manage colorblind palettes, haptic toggles, and propagate events. [Source: architecture/game-systems-components.md#core-systems][Source: architecture/shader-guidelines.md#usage-patterns]
- `res://scripts/services/localization_service.gd` – Load CSV, expose translation helpers, and broadcast locale changes. [Source: architecture/ui-component-system.md#localization-workflow]

**Modified Files:**
- `res://scripts/services/settings.gd` – Store accessibility preferences, emit change signals, and persist snapshots. [Source: architecture/data-persistence-architecture.md#save-data-structure]
- `res://scripts/services/persistence_service.gd` – Include accessibility keys in save schema. [Source: architecture/save-system-implementation.md#save-system-implementation]
- `res://scripts/ui/quick_toggle.gd` – Hook toggles to services and update icons. [Source: architecture/ui-component-system.md#component-library]
- `res://scripts/ui/session_hud.gd` – Reapply text and palette changes on locale toggle. [Source: front-end-spec.md#session_hudtscn]
- `res://scripts/gameplay/claw_input_controller.gd` – Apply sensitivity slider values to input smoothing. [Source: architecture/input-system-architecture.md#input-handling-patterns]
- `res://scripts/services/analytics_stub.gd` – Record accessibility toggle events. [Source: architecture/analytics-integration.md#event-design]

### Node/Class Definitions
**GDScript Implementation (for services):**
```gdscript
# accessibility_service.gd
class_name AccessibilityService
extends Node

signal colorblind_mode_changed(mode: StringName)
signal haptics_changed(enabled: bool)
signal camera_sensitivity_changed(value: float)

func set_colorblind_mode(mode: StringName) -> void:
    Settings.get_instance().colorblind_mode = mode
    colorblind_mode_changed.emit(mode)

func set_haptics_enabled(enabled: bool) -> void:
    Settings.get_instance().haptics_enabled = enabled
    haptics_changed.emit(enabled)
```
Signals propagate settings to shader palettes, HUD toggles, and gameplay controllers. [Source: architecture/game-systems-components.md#core-systems][Source: architecture/shader-guidelines.md#usage-patterns][Source: architecture/godot-development-conventions.md#best-practices]

### Implementation Strategy
Use services to centralize accessibility and localization, ensuring all systems reference the same state via signals. [Source: architecture/game-systems-components.md#system-interaction-session-core][Source: architecture/ui-component-system.md#localization-workflow]  
Reuse existing shader/material resources for colorblind modes and apply updates via preloaded theme dictionaries to avoid runtime allocations. [Source: architecture/shader-guidelines.md#performance-guidelines][Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]  
Persist settings on change with debounced saves to keep frame budget intact. [Source: architecture/data-persistence-architecture.md#persistence-strategy]

### Tasks / Subtasks
1. **Implement Accessibility Service (AC: 1)** – Manage colorblind, haptics, sensitivity signals. [Source: architecture/game-systems-components.md#core-systems]
2. **Build Localization Loader (AC: 2)** – Parse CSV, expose `tr_context`, update UI on locale change. [Source: architecture/ui-component-system.md#localization-workflow]
3. **Wire HUD & Gameplay (AC: 1, 3)** – Update icons, shader palettes, input sensitivity using service signals. [Source: architecture/shader-guidelines.md#usage-patterns][Source: architecture/input-system-architecture.md#input-handling-patterns]
4. **Persistence & Analytics (AC: 1, 2, 4)** – Save preferences asynchronously, emit toggle analytics. [Source: architecture/data-persistence-architecture.md#persistence-strategy][Source: architecture/analytics-integration.md#event-design]
5. **Testing & Localization QA (AC: 1–4)** – Write GUT tests, run manual toggling, validate translations, and profile to ensure <16.67 ms frames. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization][Source: architecture/performance-and-security-considerations.md#performance-budgets]

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**
- `res://tests/gut/unit/test_accessibility_service.gd`
- `res://tests/gut/unit/test_localization_service.gd`
- Coverage Target: 80% minimum. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]

**Test Scenarios (Write First - Red Phase):**
- Colorblind mode changes emit signals and update Settings/palette. [Source: architecture/shader-guidelines.md#usage-patterns]
- Localization loader returns translated strings for ENG/JP and falls back gracefully. [Source: architecture/ui-component-system.md#localization-workflow]
- Persistence round-trip restores accessibility options. [Source: architecture/data-persistence-architecture.md#save-data-structure]

### Game Testing
1. Toggle accessibility options during gameplay.  
   - Expected: Color palette updates instantly, haptics reflect new setting, sensitivity slider modifies claw input. [Source: architecture/shader-guidelines.md#usage-patterns][Source: architecture/input-system-architecture.md#input-handling-patterns]  
   - Performance: Maintain ≥60 FPS. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
2. Switch language to Japanese mid-session.  
   - Expected: HUD, tutorial overlay, and pause text update; saved preference persists across restart. [Source: architecture/ui-component-system.md#localization-workflow][Source: architecture/data-persistence-architecture.md#save-data-structure]

### Performance Tests
**Godot Profiler Metrics (Mandatory):**
- Frame rate: 60+ FPS while toggling palettes/localization. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Frame time: <16.67 ms average. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Physics frame: <4 ms. [Source: architecture/physics-configuration.md#physics-settings]
- Memory usage: <1.4 GB / 1.6 GB. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Draw calls: <720 after palette change. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]
- Object pools: Shader/material resources reused (no runtime instantiation). [Source: architecture/shader-guidelines.md#performance-guidelines]
- GDScript static typing verified. [Source: architecture/godot-development-conventions.md#best-practices]
- Save debounce ensures persistence <50 ms on worker thread. [Source: architecture/data-persistence-architecture.md#persistence-strategy]

## Dependencies
**Story Dependencies:**
- 3.2 – Responsive HUD & Pause Overlay supplies quick toggle UI. [Source: docs/stories/epic-3-tutorial-and-hud/3.2-responsive-hud-and-pause-overlay.md]
- 2.3 – Score Tracking & Persistence provides persistence framework. [Source: docs/stories/epic-2-progression-and-failstates/2.3-score-tracking-and-persistence.md]

**Godot System Dependencies:**
- Node: `SessionRoot` instantiates `AccessibilityService`, `LocalizationService`, `UIManager`, `Settings`. [Source: architecture/high-level-architecture.md#high-level-overview]
- Autoload: `Settings`, `SignalHub`, `PersistenceService`, `AnalyticsStub`. [Source: architecture/game-systems-components.md#core-systems][Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Language: Typed GDScript enforced. [Source: architecture/godot-development-conventions.md#workflow-conventions]

**Resource Dependencies:**
- Resource Type: `.tres`, `.csv`
- Asset: `colorblind_palettes.tres`, `accessibility_icons.atlas`, `strings.csv`
- Location: `res://resources/data/`, `res://resources/i18n/`, `res://ui/components/`
- Import Settings: Validate icon atlas, ensure localization CSV passes CI checks. [Source: architecture/ui-component-system.md#localization-workflow][Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]

## Definition of Done
- All acceptance criteria met. [Source: docs/game-prd/epics/epic-3-tutorial-and-hud.md#stories]
- TDD followed (tests written first, then implementation). [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GUT tests passing with 80%+ coverage. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GoDotTest passing (if applicable). [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]
- Performance: 60+ FPS maintained. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Static typing used in all GDScript. [Source: architecture/godot-development-conventions.md#best-practices]
- Object pooling active for palette/material assets. [Source: architecture/shader-guidelines.md#performance-guidelines]
- Signals properly connected and cleaned up. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- No GDScript warnings. [Source: architecture/godot-development-conventions.md#workflow-conventions]
- Node hierarchy follows architecture. [Source: architecture/high-level-architecture.md#high-level-overview]
- Resources configured properly. [Source: architecture/node-architecture-details.md#resource-architecture]
- Export templates tested. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Documentation updated. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Localization strings validated (ENG/JP). [Source: architecture/ui-component-system.md#localization-workflow]

## Notes
**Godot Implementation Notes:**
- Language Choice: GDScript maintains single-language codebase and fast iteration. [Source: architecture/godot-development-conventions.md#best-practices]
- Node Architecture: Accessibility and localization services live alongside settings autoload for centralized control. [Source: architecture/high-level-architecture.md#high-level-overview]
- Signal Pattern: Services broadcast changes through `SignalHub`/`UIManager`, decoupling UI and gameplay. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- Localization pipeline leverages CSV assets for consistent translations. [Source: architecture/ui-component-system.md#localization-workflow]

**Performance Decisions:**
- Static Typing: Required for services and UI to reduce GC overhead. [Source: architecture/godot-development-conventions.md#best-practices]
- Object Pooling: Palette resources and icons cached to avoid runtime loads. [Source: architecture/shader-guidelines.md#performance-guidelines]
- Debounced saves minimize persistence impact. [Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Shader uniforms reused to prevent recompilation. [Source: architecture/shader-guidelines.md#performance-guidelines]

**Future Optimizations:**
- Add per-player presets and export to cloud when network support arrives. [Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Introduce audio mix slider for accessibility once pause overlay matured. [Source: architecture/audio-architecture.md#system-design]
- Support additional languages by extending localization CSV schema. [Source: architecture/ui-component-system.md#localization-workflow]
