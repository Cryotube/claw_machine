# Godot Story: Responsive HUD & Pause Overlay

**Epic:** Epic 3 – Tutorial Onboarding, HUD, and Accessibility  
**Story ID:** 3.2  
**Priority:** High  
**Points:** 5  
**Status:** Draft  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Deliver a responsive HUD and pause overlay that adapts between portrait and landscape layouts, maintains thumb reach, and exposes quick toggles for haptics, colorblind filters, and sensitivity. [Source: game-prd/requirements.md#functional][Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-architecture.md#ui-system-selection]

**Godot Implementation:** Use Control node layout groups, orientation adapters, and `UIManager` signals to rearrange HUD regions and show pause overlay with quick toggles. [Source: architecture/ui-component-system.md#component-library][Source: architecture/node-architecture-details.md#node-patterns][Source: architecture/input-system-architecture.md#input-actions-configuration]

**Performance Impact:** Preload HUD scenes, reuse atlas textures, and update layouts via deferred calls to keep frame time <16.67 ms. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization][Source: architecture/performance-and-security-considerations.md#performance-budgets][Source: architecture/ui-component-system.md#data-binding]

## Acceptance Criteria
### Functional Requirements
- HUD rearranges controls and info bands when orientation changes, honoring safe-area padding and thumb reach. [Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-architecture.md#ui-system-selection]
- Pause overlay (`pause_overlay.tscn`) shows resume, restart, options, quit, and quick toggles within two taps. [Source: front-end-spec.md#pause_overlaytscn][Source: game-prd/requirements.md#functional]
- Quick toggles update `Settings` autoload and propagate to HUD elements instantly (haptics, colorblind, sensitivity). [Source: architecture/ui-component-system.md#data-binding][Source: architecture/game-systems-components.md#core-systems]
- HUD updates respect localization (ENG/JP) and maintain readability on sub-6" devices. [Source: architecture/ui-component-system.md#localization-workflow][Source: front-end-spec.md#session_hudtscn]

### Technical Requirements
- Typed GDScript for HUD controllers; orientation updates triggered by `Settings.orientation_changed`. [Source: architecture/godot-development-conventions.md#best-practices][Source: architecture/input-system-architecture.md#input-handling-patterns]
- Maintains 60+ FPS during orientation swaps and pause toggles. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Object pooling for HUD panels and toggle icons (no re-instantiation). [Source: architecture/node-architecture-details.md#node-patterns]
- Signals connected via `UIManager` and cleaned up on scene unload. [Source: architecture/ui-component-system.md#component-library]
- GUT/UI tests cover orientation logic and toggle outputs. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]
- Pause overlay blocks input to gameplay nodes while active. [Source: architecture/game-systems-components.md#core-systems]

### Game Design Requirements
- Layout preserves cozy aesthetic, uses pastel palette, and communicates state clearly. [Source: front-end-spec.md#game-visual-style-guide][Source: game-prd/goals-and-background-context.md#goals]
- Pause overlay dimming and animation match UX spec (fade in <150 ms). [Source: front-end-spec.md#pause_overlaytscn][Source: architecture/ui-component-system.md#component-library]
- Quick toggle icons reflect active state with accessible contrast. [Source: front-end-spec.md#godot-ui-component-library][Source: architecture/ui-component-system.md#component-library]

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**
- `res://ui/screens/session_hud.tscn` – Responsive HUD with orientation adapters and quick toggle row. [Source: front-end-spec.md#session_hudtscn][Source: architecture/ui-architecture.md#ui-system-selection]
- `res://ui/screens/pause_overlay.tscn` – Pause overlay card with quick toggles and safe-area layout. [Source: front-end-spec.md#pause_overlaytscn][Source: architecture/ui-component-system.md#component-library]

**New Scripts:**
- `res://scripts/ui/ui_manager.gd` – Mediates orientation, theme swaps, and quick toggle events. [Source: architecture/ui-component-system.md#component-library]
- `res://scripts/ui/quick_toggle.gd` – Handles button state, icon swaps, and `Settings` integration. [Source: front-end-spec.md#godot-ui-component-library][Source: architecture/game-systems-components.md#core-systems]

**Modified Files:**
- `res://scripts/services/settings.gd` – Emit orientation and accessibility change signals consumed by HUD. [Source: architecture/input-system-architecture.md#input-handling-patterns]
- `res://scripts/services/audio_director.gd` – Respond to haptic toggle state. [Source: architecture/audio-architecture.md#system-design]
- `res://scripts/ui/session_hud.gd` – Manage layout containers, data binding, and localization updates. [Source: front-end-spec.md#session_hudtscn]
- `res://scripts/ui/pause_overlay.gd` – Handle button callbacks, quick toggle persistence, and resume flows. [Source: front-end-spec.md#pause_overlaytscn]

### Node/Class Definitions
**GDScript Implementation (for UI):**
```gdscript
# ui_manager.gd
class_name UIManager
extends Node

signal orientation_changed(orientation: StringName)
signal quick_toggle_changed(option: StringName, enabled: bool)

func set_orientation(orientation: StringName) -> void:
    orientation_changed.emit(orientation)

func apply_quick_toggle(option: StringName, enabled: bool) -> void:
    Settings.get_instance().set_option(option, enabled)
    quick_toggle_changed.emit(option, enabled)
```
The manager centralizes orientation and toggle changes, allowing HUD panels to react via signals. [Source: architecture/ui-component-system.md#component-library][Source: architecture/game-systems-components.md#core-systems]

### Implementation Strategy
Anchor layout logic inside `UIManager` and `SessionHUD` so Control nodes simply respond to signals, simplifying orientation changes. [Source: architecture/ui-architecture.md#ui-system-selection][Source: architecture/node-architecture-details.md#node-patterns]  
Prefetch icons and styleboxes via shared theme resources to minimize draw call churn and reuse textures. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization][Source: front-end-spec.md#game-visual-style-guide]  
Test orientation swaps on device aspect ratios to confirm safe-area behavior and maintain 60 FPS. [Source: architecture/performance-and-security-considerations.md#performance-budgets]

### Tasks / Subtasks
1. **Build HUD Layout (AC: 1)** – Compose Control hierarchy with anchors for portrait/landscape and safe-area margins. [Source: front-end-spec.md#session_hudtscn]
2. **Implement UIManager (AC: 1, 3)** – Emit orientation/toggle signals, integrate with Settings, and apply theme swaps. [Source: architecture/ui-component-system.md#component-library]
3. **Create Pause Overlay (AC: 2)** – Layout card, quick toggles, button callbacks, and input blocking. [Source: front-end-spec.md#pause_overlaytscn]
4. **Wire Quick Toggles (AC: 3)** – Connect toggles to Settings, AudioDirector, AccessibilityService, and highlight updates. [Source: architecture/game-systems-components.md#core-systems]
5. **Localization & Testing (AC: 4)** – Ensure HUD text localizes, run orientation tests, and capture profiler metrics. [Source: architecture/ui-component-system.md#localization-workflow][Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]

## Testing Requirements
### Unit/UI Tests (TDD Mandatory)
**GUT Test Files:**
- `res://tests/gut/unit/test_ui_manager.gd`
- `res://tests/gut/unit/test_quick_toggle.gd`
- Coverage Target: 80% minimum. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]

**Test Scenarios (Write First - Red Phase):**
- Orientation change repositions HUD containers correctly. [Source: architecture/ui-architecture.md#ui-system-selection]
- Quick toggle updates Settings and emits signal once. [Source: architecture/game-systems-components.md#core-systems]
- Pause overlay blocks gameplay input until dismissed. [Source: architecture/game-systems-components.md#core-systems]

### Game Testing
1. Rotate device (simulated) between portrait and landscape during gameplay.  
   - Expected: HUD reorganizes, anchors obey safe areas, performance stable. [Source: front-end-spec.md#session_hudtscn][Source: architecture/performance-and-security-considerations.md#performance-budgets]
2. Enter pause overlay, toggle haptics and colorblind mode, resume.  
   - Expected: Settings persist, HUD updates instantly, haptics stop, color palette changes. [Source: architecture/game-systems-components.md#core-systems][Source: architecture/ui-component-system.md#component-library]

### Performance Tests
**Godot Profiler Metrics (Mandatory):**
- Frame rate: 60+ FPS during orientation swap. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Frame time: <16.67 ms average. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Physics frame: <4 ms (UI logic outside physics). [Source: architecture/physics-configuration.md#physics-settings]
- Memory usage: <1.4 GB / 1.6 GB. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Draw calls: <720 with HUD + overlay. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]
- Object pools: Quick toggle icons reuse resources. [Source: architecture/node-architecture-details.md#node-patterns]
- GDScript static typing verified. [Source: architecture/godot-development-conventions.md#best-practices]
- Orientation transition completes <200 ms including animations. [Source: front-end-spec.md#session_hudtscn]

## Dependencies
**Story Dependencies:**
- Tutorial story introduces UIManager signals; this story leverages them for main HUD. [Source: docs/stories/epic-3-tutorial-and-hud/3.1-tutorial-flow-and-input-gating.md]
- Epic 1 scoring to supply HUD data. [Source: docs/stories/epic-1-core-order-fulfillment-loop/1.4-order-resolution-scoring-and-reset.md]

**Godot System Dependencies:**
- Node: `SessionRoot` instantiates `UIManager`, `SessionHUD`, `PauseOverlay`, `Settings`. [Source: architecture/high-level-architecture.md#high-level-overview]
- Autoload: `Settings`, `SignalHub`, `AccessibilityService`, `AudioDirector`. [Source: architecture/game-systems-components.md#core-systems]
- Language: Typed GDScript enforced. [Source: architecture/godot-development-conventions.md#workflow-conventions]

**Resource Dependencies:**
- Resource Type: `.tres`
- Asset: `session_theme.tres`, `overlay_theme.tres`, `quick_toggle_icons.atlas`
- Location: `res://themes/`, `res://ui/components/`
- Import Settings: Atlas textures prepacked, mipmaps enabled. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]

## Definition of Done
- All acceptance criteria met. [Source: docs/game-prd/epics/epic-3-tutorial-and-hud.md#stories]
- TDD followed (tests written first, then implementation). [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GUT/UI tests passing with 80%+ coverage. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GoDotTest passing (if used). [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]
- Performance: 60+ FPS maintained. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Static typing used in all GDScript. [Source: architecture/godot-development-conventions.md#best-practices]
- Object pooling active for HUD controls. [Source: architecture/node-architecture-details.md#node-patterns]
- Signals properly connected and cleaned up. [Source: architecture/ui-component-system.md#component-library]
- No GDScript warnings. [Source: architecture/godot-development-conventions.md#workflow-conventions]
- Node hierarchy matches architecture. [Source: architecture/high-level-architecture.md#high-level-overview]
- Resources configured and themed. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]
- Export templates tested. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Documentation updated. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Orientation swap verified on target resolutions. [Source: front-end-spec.md#session_hudtscn]

## Notes
**Godot Implementation Notes:**
- Language Choice: GDScript ensures fast iteration with typed signals. [Source: architecture/godot-development-conventions.md#best-practices]
- Node Architecture: HUD and pause scenes live under `SessionRoot` with `UIManager` autoload for coordination. [Source: architecture/high-level-architecture.md#high-level-overview]
- Signal Pattern: `UIManager` broadcasts orientation/toggle changes to keep UI decoupled. [Source: architecture/ui-component-system.md#component-library]
- Themes centralize style and maintain cozy aesthetic. [Source: front-end-spec.md#game-visual-style-guide]

**Performance Decisions:**
- Static Typing: Mandatory across HUD scripts. [Source: architecture/godot-development-conventions.md#best-practices]
- Object Pooling: Quick toggle buttons reuse icon textures and Control nodes. [Source: architecture/node-architecture-details.md#node-patterns]
- Deferred layout recalculation prevents frame spikes. [Source: architecture/ui-component-system.md#data-binding]
- Overlay animations limited to short tweens to stay under frame budget. [Source: architecture/performance-and-security-considerations.md#performance-budgets]

**Future Optimizations:**
- Add customizable HUD presets once analytics identifies comfort preferences. [Source: docs/game-prd/epics/epic-3-tutorial-and-hud.md#outcomes]
- Integrate vibration intensity slider within quick toggles when accessibility story lands. [Source: docs/game-prd/epics/epic-3-tutorial-and-hud.md#description]
- Evaluate auto-hide HUD for streaming mode (post-MVP). [Source: game-prd/goals-and-background-context.md#background-context]
