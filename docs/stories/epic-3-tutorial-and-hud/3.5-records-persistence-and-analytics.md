# Godot Story: Records Persistence & Analytics Hardening

**Epic:** Epic 3 – Tutorial Onboarding, HUD, and Accessibility  
**Story ID:** 3.5  
**Priority:** High  
**Points:** 5  
**Status:** Ready for Review  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Capture run results, surface them on the Records screen, and harden analytics so post-run flows persist and report data reliably. Players must be able to finish a run, view their history with localized timestamps, and share consistent telemetry for QA verification. [Source: summary.md#1-0-recovery-plan][Source: docs/front-end-spec.md#screen-specifications][Source: docs/architecture/data-persistence-architecture.md#save-data-structure]

**Godot Implementation:** Extend `PersistenceService` and `SceneDirector` so score runs append summaries, flush to disk, and reload into the Records UI. Upgrade `RecordsScreen` visuals to bind summary metrics, history list, and empty state; ensure analytics events (`menu_nav`, `game_over_shown`) include the required payload. [Source: docs/front-end-spec.md#screen-specifications][Source: docs/architecture/scene-management-architecture.md#scene-structure][Source: docs/architecture/analytics-integration.md#event-design]

**Performance Impact:** Flush persistence asynchronously and reuse UI nodes to avoid frame hitching during transitions. Analytics writes should batch to keep main thread <16.67 ms even when summarizing runs. [Source: docs/architecture/performance-and-security-considerations.md#performance-budgets][Source: docs/architecture/ui-component-system.md#data-binding]

## Acceptance Criteria
### Functional Requirements
- Score runs append `{score, wave, combo_peak, duration_sec, failure_reason, timestamp_sec}` to persistence, update summary metrics, and flush before transitioning to Records. Run history caps at 25 entries while keeping newest-first ordering. [Source: docs/architecture/data-persistence-architecture.md#save-data-structure][Source: docs/architecture/save-system-implementation.md#save-system-implementation]
- Records screen binds to persistence on enter (from menu or game-over auto advance) and renders: high score, previous score delta, best wave, fastest duration, last run summary, and a localized history list (<=10 entries). Empty state shows UX copy and CTA when no runs exist. [Source: docs/front-end-spec.md#screen-specifications][Source: docs/ux/phase1-ux-refresh.md]
- `SceneDirector` passes run metadata into Records so newly completed runs highlight with contextual copy (e.g., “New High Score” when applicable) and back navigation returns to main menu without losing state. [Source: docs/ux/phase1-ux-refresh.md][Source: docs/architecture/scene-management-architecture.md#scene-structure]

### Technical Requirements
- `PersistenceService` enforces schema version `save_schema_v1.tres`, provides migration hook for future schemas, and exposes deterministic `flush_if_dirty()` / `flush_now()` used by post-run flow. [Source: docs/architecture/data-persistence-architecture.md#save-data-structure][Source: resources/data/save_schema_v1.tres]
- Add typed helpers for retrieving summary/high-score snapshot and history, ensuring deep copies to avoid accidental mutation from UI code. [Source: docs/architecture/godot-development-conventions.md#best-practices]
- Update `RecordsScreen` to use typed GDScript, format timestamps via `LocalizationService`, and listen to `SignalHub` high-score broadcasts for live updates. [Source: docs/architecture/ui-component-system.md#data-binding][Source: docs/architecture/game-systems-components.md#system-interaction-session-core]
- Ensure analytics log buffer persists across scene transitions, supports explicit flush to disk, and trims safely when capacity exceeded. [Source: docs/architecture/analytics-integration.md#event-design]

### Analytics Requirements
- `game_over_shown` event fires exactly once per display with payload `{score, wave, failure_reason, duration_sec, auto, timestamp_ms}`; continuing or auto-advance emits `menu_nav` actions (`game_over_continue`, `game_over_auto`). [Source: docs/architecture/analytics-integration.md#event-design][Source: docs/front-end-spec.md#screen-specifications]
- Records entry emits `screen_view` / `menu_nav` events with `{source: game_over|menu, action: records}` and differentiates empty state vs populated history via metadata for downstream QA checks. [Source: docs/architecture/analytics-integration.md#event-design]
- Provide analytics flush command callable by tests to write queued events to `user://analytics.log`, ensuring persistence for regression scripts. [Source: summary.md#1-0-recovery-plan][Source: docs/architecture/test-strategy-and-standards.md#automation-guidelines]

### Testing Requirements
- GUT unit tests cover persistence append/summary recalculation, analytics flush behavior, and localized history formatting. [Source: docs/architecture/test-strategy-and-standards.md#godot-test-types-and-organization]
- UI/smoke test exercises Game Over → Records flow, verifying metadata flagging (new high score, empty state) and analytics payload emission via stub. [Source: docs/architecture/test-strategy-and-standards.md#automation-guidelines]
- Add scripted regression in `scripts/godot-cli.sh` (or equivalent) that runs post-run replay, validates `menu_nav` / `game_over_shown` events, and confirms analytics log file contains serialized payload. [Source: summary.md#1-0-recovery-plan][Source: docs/architecture/analytics-integration.md#implementation]

### Game Design & UX Requirements
- Records screen uses refreshed UX layout: metric cards with icons, scrollable history list, share CTA stub, and localized copy that respects reduced-motion toggle for countdown ring animations. [Source: docs/ux/phase1-ux-refresh.md][Source: docs/front-end-spec.md#screen-specifications]
- Game Over summary messaging mirrors design copy, indicates when a new high score or best wave occurs, and ensures accessibility palettes apply to summary and CTA buttons. [Source: docs/ux/phase1-ux-refresh.md][Source: docs/front-end-spec.md#screen-specifications]

## Technical Specifications
### Files to Create/Modify
- `res://autoload/persistence_service.gd` – Extend schema enforcement, flush hooks, and run summary helpers.
- `res://autoload/analytics_stub.gd` – Implement flush-to-disk operation, buffer trimming, and configuration accessors.
- `res://autoload/scene_director.gd` – Pass run metadata into Records entry.
- `res://scripts/ui/records_screen.gd` & `res://ui/screens/records_screen.tscn` – Bind summary cards, history list, empty state, share CTA.
- `res://scripts/ui/game_over_screen.gd` – Emit contextual summary metadata and analytics events.
- `res://scripts/services/order_resolution_pipeline.gd` – Trigger persistence append/flush at run completion.
- `res://scripts/tests/post_run_replay.gd` or similar harness – Replay run summary for analytics validation.
- `res://tests/gut/ui/test_records_screen.gd`, `res://tests/gut/unit/test_analytics_stub.gd` – New/updated tests.
- `docs/architecture/data-persistence-architecture.md`, `docs/architecture/analytics-integration.md`, `docs/qa/checklists/records-flow.md` – Document updates.

### Resource Dependencies
- `res://resources/data/save_schema_v1.tres`
- `res://resources/i18n/ui_screens.csv`
- `res://resources/themes/records_metrics_theme.tres` (create if needed for metric cards/icons)

## Testing Requirements
### Automated
- Update `scripts/godot-cli.sh --headless` suite to include post-run replay + analytics flush verification.
- GUT coverage ≥80% across new persistence helpers, analytics flush, and Records UI formatting.

### Manual QA
- Validate Records screen on iPhone 12/Pixel 6 portrait & landscape, controller navigation, and empty-state messaging.
- Confirm analytics log written after runs and accessible for export QA.
- Verify reduced-motion and localization toggles propagate to Game Over + Records layouts.

## Definition of Done
- Acceptance criteria satisfied with passing automated/manual checks.
- QA gate updated with new persistence/analytics checklist items.
- Documentation refreshed for persistence schema, analytics flush workflow, and Records UX behavior.
- UX sign-off on Records visuals and Game Over messaging.

## Notes
- Coordinate with Audio/Haptics polish phase to reuse CTA hooks for future cues.
- Keep persistence migrations forward-compatible; do not break existing save files.
- Ensure analytics flush helper is safe to call from tests and during shutdown.
