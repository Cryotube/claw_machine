# Godot Story: Tutorial Flow & Input Gating

**Epic:** Epic 3 – Tutorial Onboarding, HUD, and Accessibility  
**Story ID:** 3.1  
**Priority:** High  
**Points:** 5  
**Status:** Approved
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Create an interactive tutorial that teaches claw controls step-by-step, gating input until each objective is complete. The tutorial orchestrator must integrate with HUD prompts, analytics, and persistence so players can resume after completion. [Source: game-prd/requirements.md#functional][Source: architecture/game-systems-components.md#core-systems][Source: architecture/gameplay-systems-architecture.md#gameplay-components]

**Godot Implementation:** Implement a `TutorialOrchestrator` node that sequences steps, locks input via `ClawInputController`, and triggers HUD overlays and analytics events for each completed step. [Source: architecture/state-machine-architecture.md#entity-state-machines][Source: architecture/input-system-architecture.md#input-handling-patterns][Source: architecture/analytics-integration.md#event-design]

**Performance Impact:** Use lightweight overlays, reuse Control nodes, and avoid blocking logic so the tutorial maintains <16.67 ms frame time on mobile devices. [Source: architecture/performance-and-security-considerations.md#performance-budgets][Source: architecture/ui-component-system.md#data-binding]

## Acceptance Criteria
### Functional Requirements
- Tutorial sequences `aim`, `lower`, `grip`, `release`, and `serve` steps, locking input until each objective passes. [Source: front-end-spec.md#player-goal-learn-claw-controls-order-flow-and-hud-meaning-before-entering-score-run][Source: architecture/state-machine-architecture.md#entity-state-machines][Source: architecture/input-system-architecture.md#input-actions-configuration]
- Step completions emit `tutorial_step_completed` analytics events with `step_id` and duration. [Source: architecture/analytics-integration.md#event-design]
- Tutorial completion flag stored via `PersistenceService` and prevents replay unless reset. [Source: architecture/data-persistence-architecture.md#save-data-structure][Source: architecture/save-system-implementation.md#save-system-implementation]
- Skip option appears after completion, respecting accessibility guardrails and settings. [Source: docs/game-prd/epics/epic-3-tutorial-and-hud.md#risks--mitigations][Source: architecture/ui-architecture.md#ui-system-selection]

### Technical Requirements
- Typed GDScript orchestrator with enum-based state machine. [Source: architecture/state-machine-architecture.md#entity-state-machines][Source: architecture/godot-development-conventions.md#best-practices]
- Maintains 60+ FPS; overlays use pooled Control nodes. [Source: architecture/performance-and-security-considerations.md#performance-budgets][Source: architecture/ui-component-system.md#component-library]
- Signals cleanly connect/disconnect; InputMap gating restored after tutorial. [Source: architecture/game-systems-components.md#core-systems]
- GUT coverage ≥ 80% for orchestrator logic. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- Persistence writes occur asynchronously. [Source: architecture/data-persistence-architecture.md#persistence-strategy]

### Game Design Requirements
- Tutorial copy localized (ENG/JP) and matches UX tone. [Source: architecture/ui-component-system.md#localization-workflow][Source: game-prd/goals-and-background-context.md#background-context]
- Overlays anchor per orientation guidelines and maintain thumb reach. [Source: front-end-spec.md#player-goal-learn-claw-controls-order-flow-and-hud-meaning-before-entering-score-run][Source: architecture/ui-architecture.md#ui-system-selection]
- Accessibility hints highlight relevant controls, including colorblind cues. [Source: docs/game-prd/epics/epic-3-tutorial-and-hud.md#description][Source: architecture/ui-component-system.md#component-library]

## Technical Specifications
### Files to Create/Modify
**New Scripts:**
- `res://scripts/services/tutorial_orchestrator.gd` – Drives step state machine, locks input, and displays prompts. [Source: architecture/state-machine-architecture.md#entity-state-machines][Source: architecture/input-system-architecture.md#input-handling-patterns]
- `res://scripts/ui/tutorial_overlay.gd` – Shows instruction cards, highlight indicators, and skip option. [Source: front-end-spec.md#player-goal-learn-claw-controls-order-flow-and-hud-meaning-before-entering-score-run][Source: architecture/ui-component-system.md#component-library]

**Modified Files:**
- `res://scripts/gameplay/claw_input_controller.gd` – Accept tutorial gating callbacks. [Source: architecture/input-system-architecture.md#input-handling-patterns]
- `res://scripts/ui/session_hud.gd` – Display tutorial progress indicators and disable conflicting overlays. [Source: architecture/ui-component-system.md#data-binding]
- `res://scripts/services/persistence_service.gd` – Store tutorial completion flag. [Source: architecture/save-system-implementation.md#save-system-implementation]
- `res://scripts/services/analytics_stub.gd` – Append `tutorial_step_completed` events. [Source: architecture/analytics-integration.md#event-design]
- `res://autoload/SignalHub.gd` – Add tutorial signals (`tutorial_step_started`, `tutorial_completed`). [Source: architecture/game-systems-components.md#system-interaction-session-core]

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# tutorial_orchestrator.gd
class_name TutorialOrchestrator
extends Node

enum Step { AIM, LOWER, GRIP, RELEASE, SERVE, COMPLETE }

@export var input_controller: ClawInputController
@export var overlay: TutorialOverlay

var _current_step: Step = Step.AIM
var _step_started_at: float = 0.0

func start() -> void:
    _current_step = Step.AIM
    _step_started_at = Time.get_ticks_msec()
    overlay.show_step(_current_step)
    input_controller.lock_to_tutorial(_current_step)
```
The orchestrator uses an enum state machine, locks input via controller hooks, and timestamps steps for analytics. [Source: architecture/state-machine-architecture.md#entity-state-machines][Source: architecture/input-system-architecture.md#input-handling-patterns][Source: architecture/analytics-integration.md#event-design]

### Implementation Strategy
Leverage a dedicated tutorial state machine to ensure deterministic gating and easy testing; the orchestrator publishes signals for HUD, audio, and analytics. [Source: architecture/state-machine-architecture.md#entity-state-machines][Source: architecture/game-systems-components.md#system-interaction-session-core]  
Reuse overlay components and highlight nodes from previous stories to minimize new assets and maintain 60 FPS. [Source: architecture/ui-component-system.md#component-library][Source: architecture/performance-and-security-considerations.md#performance-budgets]  
Persist completion status immediately after tutorial finish and on session exit to avoid repeated onboarding. [Source: architecture/data-persistence-architecture.md#persistence-strategy]

### Tasks / Subtasks
1. **Design Tutorial Steps (AC: 1)** – Define step data (id, instruction key, required signal) in resource. [Source: architecture/node-architecture-details.md#resource-architecture]
2. **Implement Orchestrator (AC: 1, 2)** – Build state machine, input locks, and analytics emission. [Source: architecture/state-machine-architecture.md#entity-state-machines][Source: architecture/analytics-integration.md#event-design]
3. **Overlay & HUD Integration (AC: 1, 3)** – Display instructions, orientation-safe placement, skip button, and accessibility cues. [Source: front-end-spec.md#player-goal-learn-claw-controls-order-flow-and-hud-meaning-before-entering-score-run][Source: architecture/ui-architecture.md#ui-system-selection]
4. **Persistence + Skip Logic (AC: 4)** – Save completion flag, conditionally show skip option, and provide reset hook. [Source: architecture/save-system-implementation.md#save-system-implementation]
5. **TDD & Playtest (AC: 1–4)** – Write GUT tests for step transitions, run manual tutorial playthrough ensuring 60+ FPS and accurate analytics. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization][Source: architecture/performance-and-security-considerations.md#performance-budgets]

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**
- `res://tests/gut/unit/test_tutorial_orchestrator.gd`
- `res://tests/gut/unit/test_tutorial_overlay.gd`
- Coverage Target: 80% minimum. [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]

**Test Scenarios (Write First - Red Phase):**
- Tutorial steps advance only when required signals fire. [Source: architecture/state-machine-architecture.md#entity-state-machines]
- Skip unlocks after completion flag set. [Source: architecture/save-system-implementation.md#save-system-implementation]
- Analytics payload contains step id and duration. [Source: architecture/analytics-integration.md#event-design]

### Game Testing
1. Run tutorial from fresh profile.  
   - Expected: Input locked each step, prompts localized, analytics log records step events. [Source: front-end-spec.md#player-goal-learn-claw-controls-order-flow-and-hud-meaning-before-entering-score-run][Source: architecture/analytics-integration.md#event-design]  
   - Performance: Maintain ≥60 FPS; overlay updates do not spike frame time. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
2. Restart game after completion.  
   - Expected: Skip option available, tutorial bypassed unless user resets; settings remain. [Source: architecture/data-persistence-architecture.md#save-data-structure][Source: architecture/ui-architecture.md#ui-system-selection]

### Performance Tests
**Godot Profiler Metrics (Mandatory):**
- Frame rate: 60+ FPS during tutorial overlays. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Frame time: <16.67 ms average. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Physics frame: <4 ms (tutorial logic outside physics). [Source: architecture/physics-configuration.md#physics-settings]
- Memory usage: <1.4 GB / 1.6 GB. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Draw calls: <700 with overlays active. [Source: architecture/rendering-pipeline-configuration.md#rendering-optimization]
- Object pools: Tutorial highlights reused, no new Control instantiation. [Source: architecture/ui-component-system.md#component-library]
- GDScript static typing verified. [Source: architecture/godot-development-conventions.md#best-practices]
- Persistence saves <50 ms on worker thread. [Source: architecture/data-persistence-architecture.md#persistence-strategy]

## Dependencies
**Story Dependencies:**
- Epic 1 loop and Epic 2 persistence must be in place to demonstrate actual gameplay interactions. [Source: docs/stories/epic-1-core-order-fulfillment-loop/1.4-order-resolution-scoring-and-reset.md][Source: docs/stories/epic-2-progression-and-failstates/2.3-score-tracking-and-persistence.md]

**Godot System Dependencies:**
- Node: `SessionRoot` instantiates `TutorialOrchestrator`, `ClawInputController`, `SessionHUD`. [Source: architecture/high-level-architecture.md#high-level-overview]
- Autoload: `SignalHub`, `PersistenceService`, `AnalyticsStub`, `Settings`. [Source: architecture/game-systems-components.md#core-systems][Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Language: Typed GDScript enforced. [Source: architecture/godot-development-conventions.md#workflow-conventions]

**Resource Dependencies:**
- Resource Type: `.tres`
- Asset: `tutorial_steps.tres`, `tutorial_strings.csv`, highlight icons.
- Location: `res://resources/data/`, `res://resources/i18n/`
- Import Settings: Ensure localization csv validated, highlight textures compressed for mobile. [Source: architecture/ui-component-system.md#localization-workflow][Source: architecture/node-architecture-details.md#resource-architecture]

## Definition of Done
- All acceptance criteria met. [Source: docs/game-prd/epics/epic-3-tutorial-and-hud.md#stories]
- TDD followed (tests written first, then implementation). [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GUT tests passing with 80%+ coverage. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- GoDotTest passing (if applicable). [Source: architecture/test-strategy-and-standards.md#godot-test-types-and-organization]
- Performance: 60+ FPS maintained. [Source: architecture/performance-and-security-considerations.md#performance-budgets]
- Static typing used in all GDScript. [Source: architecture/godot-development-conventions.md#best-practices]
- Object pooling active for overlays/highlights. [Source: architecture/ui-component-system.md#component-library]
- Signals properly connected and cleaned up. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- No GDScript warnings. [Source: architecture/godot-development-conventions.md#workflow-conventions]
- Node hierarchy follows architecture. [Source: architecture/high-level-architecture.md#high-level-overview]
- Resources configured and localized. [Source: architecture/ui-component-system.md#localization-workflow]
- Export templates tested. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Documentation updated. [Source: architecture/core-game-workflows.md#core-game-workflows]
- Tutorial completion verified via persistence reload. [Source: architecture/save-system-implementation.md#save-system-implementation]

## Notes
**Godot Implementation Notes:**
- Language Choice: GDScript enables rapid iteration while adhering to single-language strategy. [Source: architecture/godot-development-conventions.md#best-practices]
- Node Architecture: Orchestrator sits alongside session nodes for direct input access. [Source: architecture/high-level-architecture.md#high-level-overview]
- Signal Pattern: `SignalHub` distributes tutorial step events to HUD, analytics, and persistence. [Source: architecture/game-systems-components.md#system-interaction-session-core]
- Localization uses existing CSV pipeline to support ENG/JP text. [Source: architecture/ui-component-system.md#localization-workflow]

**Performance Decisions:**
- Static Typing: Mandatory for tutorial logic and overlay scripts. [Source: architecture/godot-development-conventions.md#best-practices]
- Object Pooling: Tutorial overlays reused across sessions. [Source: architecture/ui-component-system.md#component-library]
- Asynchronous persistence prevents frame hitches during completion saves. [Source: architecture/data-persistence-architecture.md#persistence-strategy]
- Overlay animations limited to tween-based fades to keep frame cost low. [Source: architecture/performance-and-security-considerations.md#performance-budgets]

**Future Optimizations:**
- Add optional advanced tips once analytics show strong retention. [Source: docs/game-prd/epics/epic-3-tutorial-and-hud.md#risks--mitigations]
- Integrate voiceover cues using existing audio bus if playtests request additional guidance. [Source: architecture/audio-architecture.md#system-design]
- Provide tutorial recap accessible from pause menu for returning players. [Source: architecture/ui-architecture.md#ui-system-selection]
